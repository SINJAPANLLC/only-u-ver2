Last login: Mon Oct 27 18:51:00 on ttys092
kazuyaotani@kazuya-MacBook-Air-2 ~ % >....                                      
  }

  async getPublicObjectSearchPaths(): Promise<Array<string>> {
    return ['public'];
  }

  async getPrivateObjectDir(): Promise<string> {
    return 'private';
  }
}

export const replitClient = null;
export const objectStorageClient = null;
EOF

# 再ビルド
npm run build

# PM2で再起動
pm2 restart only-u --update-env

# ログを確認
pm2 logs only-u --lines 50
cd: no such file or directory: /var/www/only-u
zsh: command not found: #
zsh: no such file or directory: server/firebase.ts
zsh: command not found: #
zsh: no such file or directory: server/objectStorage.ts
zsh: command not found: #
npm error code ENOENT
npm error syscall open
npm error path /Users/kazuyaotani/package.json
npm error errno -2
npm error enoent Could not read package.json: Error: ENOENT: no such file or directory, open '/Users/kazuyaotani/package.json'
npm error enoent This is related to npm not being able to find a file.
npm error enoent
npm error A complete log of this run can be found in: /Users/kazuyaotani/.npm/_logs/2025-10-27T10_37_56_313Z-debug-0.log
zsh: command not found: #
zsh: command not found: pm2
zsh: command not found: #
zsh: command not found: pm2
kazuyaotani@kazuya-MacBook-Air-2 ~ % 
kazuyaotani@kazuya-MacBook-Air-2 ~ % ssh root@212.85.24.206
The authenticity of host '212.85.24.206 (212.85.24.206)' can't be established.
ED25519 key fingerprint is SHA256:4wszb0rq6W7AdzWWnBUbKmie2qybqww6kLz4/rpM89k.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '212.85.24.206' (ED25519) to the list of known hosts.
root@212.85.24.206's password: 
Welcome to Ubuntu 24.04.3 LTS (GNU/Linux 6.8.0-85-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

 System information as of Mon Oct 27 10:38:33 UTC 2025

  System load:  0.05              Processes:             109
  Usage of /:   4.2% of 95.82GB   Users logged in:       0
  Memory usage: 7%                IPv4 address for eth0: 212.85.24.206
  Swap usage:   0%                IPv6 address for eth0: 2a02:4780:59:cc86::1


Expanded Security Maintenance for Applications is not enabled.

0 updates can be applied immediately.

Enable ESM Apps to receive additional future security updates.
See https://ubuntu.com/esm or run: sudo pro status


*** System restart required ***
Last login: Mon Oct 27 10:27:05 2025 from 212.85.24.206
root@srv1087935:~# cd /var/www/only-u

cat > server/firebase.ts << 'EOF'
import admin from 'firebase-admin';

if (!admin.apps.length) {
  admin.initializeApp({
    projectId: 'onlyu1020-c6696',
    storageBucket: 'onlyu1020-c6696.firebasestorage.app',
  });
}

export { admin };
export const firestore = admin.firestore();
export const auth = admin.auth();
export const storage = admin.storage();
EOF

cat > server/objectStorage.ts << 'EOF'
import { Storage as FirebaseStorage } from "firebase-admin/storage";
import { Response } from "express";
import { randomUUID } from "crypto";

export class ObjectNotFoundError extends Error {
        console.error('[normalizeObjectEntityPath] Failech[1]);\/(.+)$/);'; = 36
> 
> ssh root@212.85.24.206
> ^C
root@srv1087935:/var/www/only-u# ssh root@212.85.24.206
root@212.85.24.206's password: 
Welcome to Ubuntu 24.04.3 LTS (GNU/Linux 6.8.0-85-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

 System information as of Mon Oct 27 10:38:33 UTC 2025

  System load:  0.05              Processes:             109
  Usage of /:   4.2% of 95.82GB   Users logged in:       0
  Memory usage: 7%                IPv4 address for eth0: 212.85.24.206
  Swap usage:   0%                IPv6 address for eth0: 2a02:4780:59:cc86::1


Expanded Security Maintenance for Applications is not enabled.

0 updates can be applied immediately.

Enable ESM Apps to receive additional future security updates.
See https://ubuntu.com/esm or run: sudo pro status


*** System restart required ***
Last login: Mon Oct 27 10:38:33 2025 from 116.81.22.135
root@srv1087935:~# cd /var/www/only-u
npm run build
pm2 restart only-u --update-env
pm2 logs only-u --lines 50

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

vite v5.4.20 building for production...
transforming (14) src/components/pages/RankingPage.jsxBrowserslist: browsers data (caniuse-lite) is 12 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 2900 modules transformed.
../dist/public/index.html                                                           1.99 kB │ gzip:   0.77 kB
../dist/public/assets/S__23355436_1761458269036-DnkfgHoF.jpg                       36.69 kB
../dist/public/assets/S__23355435_1761458437613-ZtUTYoEc.jpg                       51.25 kB
../dist/public/assets/00465-2336099699_0_1760917144954-6NSR4Dbx.jpg                59.23 kB
../dist/public/assets/00021-2650716505_0_1760917144954-CbSPvP-L.jpg                71.74 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.17.14_1760917144953-C-4BMTeW.png    352.54 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.23.36_1760917144953-C5nM0uTg.png    374.27 kB
../dist/public/assets/00035-3167998813_1760917144953-djSIga3e.png                 581.24 kB
../dist/public/assets/00220-1604543024_0_1760917144953-DgriXLtA.png               632.22 kB
../dist/public/assets/1_1761457956151-sxUpn9Sz.png                              3,238.67 kB
../dist/public/assets/3_1761457956151-BpStuj2a.png                              3,495.80 kB
../dist/public/assets/2_1761457956151-D6P7x4Q3.png                              3,792.85 kB
../dist/public/assets/index-Cjs4TzwM.css                                          181.51 kB │ gzip:  26.96 kB
../dist/public/assets/index-IK1SN_SD.js                                         2,061.70 kB │ gzip: 494.32 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 9.01s

  dist/index.js  54.4kb

⚡ Done in 9ms
[PM2] Applying action restartProcessId on app [only-u](ids: [ 0 ])
[PM2] [only-u](0) ✓
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ only-u             │ fork     │ 6    │ online    │ 0%       │ 19.1mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[TAILING] Tailing last 50 lines for [only-u] process (change the value with --lines option)
/root/.pm2/logs/only-u-out.log last 50 lines:
/root/.pm2/logs/only-u-error.log last 50 lines:
0|only-u   |     code: 'ECONNREFUSED',
0|only-u   |     syscall: 'connect',
0|only-u   |     address: '127.0.0.1',
0|only-u   |     port: 1106
0|only-u   |   }
0|only-u   | }
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:490:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   | TypeError: fetch failed
0|only-u   |     at node:internal/deps/undici/undici:13510:13
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async getDefaultBucketId (file:///var/www/only-u/node_modules/@replit/object-storage/dist/index.mjs:62:20)
0|only-u   |     at async Client.init (file:///var/www/only-u/node_modules/@replit/object-storage/dist/index.mjs:99:51) {
0|only-u   |   [cause]: Error: connect ECONNREFUSED 127.0.0.1:1106
0|only-u   |       at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1611:16) {
0|only-u   |     errno: -111,
0|only-u   |     code: 'ECONNREFUSED',
0|only-u   |     syscall: 'connect',
0|only-u   |     address: '127.0.0.1',
0|only-u   |     port: 1106
0|only-u   |   }
0|only-u   | }
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:490:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   | TypeError: fetch failed
0|only-u   |     at node:internal/deps/undici/undici:13510:13
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async getDefaultBucketId (file:///var/www/only-u/node_modules/@replit/object-storage/dist/index.mjs:62:20)
0|only-u   |     at async Client.init (file:///var/www/only-u/node_modules/@replit/object-storage/dist/index.mjs:99:51) {
0|only-u   |   [cause]: Error: connect ECONNREFUSED 127.0.0.1:1106
0|only-u   |       at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1611:16) {
0|only-u   |     errno: -111,
0|only-u   |     code: 'ECONNREFUSED',
0|only-u   |     syscall: 'connect',
0|only-u   |     address: '127.0.0.1',
0|only-u   |     port: 1106
0|only-u   |   }
0|only-u   | }
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:220:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)

0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
cat server/firebase.ts
^C
root@srv1087935:/var/www/only-u# cat server/firebase.ts
import admin from 'firebase-admin';

if (!admin.apps.length) {
  admin.initializeApp({
    projectId: 'onlyu1020-c6696',
    storageBucket: 'onlyu1020-c6696.firebasestorage.app',
  });
}

export { admin };
export const firestore = admin.firestore();
export const auth = admin.auth();
export const storage = admin.storage();
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# # 現在のファイルを確認
cat server/firebase.ts

# もしまだ古い内容なら、以下で上書き
cat > server/firebase.ts << 'EOF'
import admin from 'firebase-admin';

if (!admin.apps.length) {
  admin.initializeApp({
    projectId: 'onlyu1020-c6696',
    storageBucket: 'onlyu1020-c6696.firebasestorage.app',
  });
}

export { admin };
export const firestore = admin.firestore();
export const auth = admin.auth();
export const storage = admin.storage();
EOF

# objectStorage.tsの先頭部分を確認
head -n 30 server/objectStorage.ts
import admin from 'firebase-admin';

if (!admin.apps.length) {
  admin.initializeApp({
    projectId: 'onlyu1020-c6696',
    storageBucket: 'onlyu1020-c6696.firebasestorage.app',
  });
}

export { admin };
export const firestore = admin.firestore();
export const auth = admin.auth();
export const storage = admin.storage();
// Object Storage Service for managing large video and image uploads
// Modified for VPS deployment - uses Firebase Storage instead of Replit Object Storage
import { Storage as FirebaseStorage } from "firebase-admin/storage";
import { Response } from "express";
import { randomUUID } from "crypto";

export class ObjectNotFoundError extends Error {
  constructor() {
    super("Object not found");
    this.name = "ObjectNotFoundError";
    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);
  }
}

let firebaseStorageBucket: ReturnType<FirebaseStorage["bucket"]> | null = null;

async function getFirebaseStorageBucket() {
  if (!firebaseStorageBucket) {
    const { storage } = await import('./firebase');
    firebaseStorageBucket = storage.bucket();
  }
  return firebaseStorageBucket;
}

export class ObjectStorageService {
  constructor() {}

  async uploadFile(
    fileBuffer: Buffer,
    fileName: string,
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# c^C
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# 
root@srv1087935:/var/www/only-u# # 現在のファイルを確認
cat server/firebase.ts

# もしまだ古い内容なら、以下で上書き
cat > server/firebase.ts << 'EOF'
import admin from 'firebase-admin';

if (!admin.apps.length) {
  admin.initializeApp({
    projectId: 'onlyu1020-c6696',
    storageBucket: 'onlyu1020-c6696.firebasestorage.app',
  });
}

export { admin };
export const firestore = admin.firestore();
export const auth = admin.auth();
export const storage = admin.storage();
EOF

# objectStorage.tsの先頭部分を確認
head -n 30 server/objectStorage.ts
import admin from 'firebase-admin';

if (!admin.apps.length) {
  admin.initializeApp({
    projectId: 'onlyu1020-c6696',
    storageBucket: 'onlyu1020-c6696.firebasestorage.app',
  });
}

export { admin };
export const firestore = admin.firestore();
export const auth = admin.auth();
export const storage = admin.storage();
// Object Storage Service for managing large video and image uploads
// Modified for VPS deployment - uses Firebase Storage instead of Replit Object Storage
import { Storage as FirebaseStorage } from "firebase-admin/storage";
import { Response } from "express";
import { randomUUID } from "crypto";

export class ObjectNotFoundError extends Error {
  constructor() {
    super("Object not found");
    this.name = "ObjectNotFoundError";
    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);
  }
}

let firebaseStorageBucket: ReturnType<FirebaseStorage["bucket"]> | null = null;

async function getFirebaseStorageBucket() {
  if (!firebaseStorageBucket) {
    const { storage } = await import('./firebase');
    firebaseStorageBucket = storage.bucket();
  }
  return firebaseStorageBucket;
}

export class ObjectStorageService {
  constructor() {}

  async uploadFile(
    fileBuffer: Buffer,
    fileName: string,
root@srv1087935:/var/www/only-u# 
root@srv1087935:/var/www/only-u# # 1. 環境変数ファイルを確認
cat .env.production

# 2. distフォルダを削除して完全再ビルド
rm -rf dist
npm run build

# 3. PM2を完全に停止してから起動
pm2 delete only-u
pm2 start npm --name "only-u" -- start

# 4. ログを確認
pm2 logs only-u --lines 50
NODE_ENV=production
PORT=5000
VITE_API_URL=https://only-u.fun
SESSION_SECRET=vK8mN3xP9qR2wE5tY7uI0oP3aS6dF8gH1jK4lZ7xC9vB2nM5qW8eR1tY4uI6oP9a

VITE_FIREBASE_API_KEY=AIzaSyCvUJiZlQMztRs61qTZD7UnY5AYQQ3N1TM
VITE_FIREBASE_PROJECT_ID=onlyu1020-c6696
VITE_FIREBASE_AUTH_DOMAIN=onlyu1020-c6696.firebaseapp.com
VITE_FIREBASE_STORAGE_BUCKET=onlyu1020-c6696.firebasestorage.app
VITE_FIREBASE_MESSAGING_SENDER_ID=627626524087
VITE_FIREBASE_APP_ID=1:627626524087:web:3fb2db22334c6c4e79bc32

VITE_STRIPE_PUBLIC_KEY=pk_live_51SJLZVQXzSGbl6lJ6uiGIHc5dIir5GbtrS0I9g4S3SokXhDuH3eXcK3F7KD4RjdWGtwtuBzcqMyT50pBV1GB1tOs00WNjwwGnW
STRIPE_SECRET_KEY=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

STORAGE_PROVIDER=firebase

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

vite v5.4.20 building for production...
transforming (3) src/main.jsxBrowserslist: browsers data (caniuse-lite) is 12 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 2900 modules transformed.
../dist/public/index.html                                                           1.99 kB │ gzip:   0.77 kB
../dist/public/assets/S__23355436_1761458269036-DnkfgHoF.jpg                       36.69 kB
../dist/public/assets/S__23355435_1761458437613-ZtUTYoEc.jpg                       51.25 kB
../dist/public/assets/00465-2336099699_0_1760917144954-6NSR4Dbx.jpg                59.23 kB
../dist/public/assets/00021-2650716505_0_1760917144954-CbSPvP-L.jpg                71.74 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.17.14_1760917144953-C-4BMTeW.png    352.54 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.23.36_1760917144953-C5nM0uTg.png    374.27 kB
../dist/public/assets/00035-3167998813_1760917144953-djSIga3e.png                 581.24 kB
../dist/public/assets/00220-1604543024_0_1760917144953-DgriXLtA.png               632.22 kB
../dist/public/assets/1_1761457956151-sxUpn9Sz.png                              3,238.67 kB
../dist/public/assets/3_1761457956151-BpStuj2a.png                              3,495.80 kB
../dist/public/assets/2_1761457956151-D6P7x4Q3.png                              3,792.85 kB
../dist/public/assets/index-Cjs4TzwM.css                                          181.51 kB │ gzip:  26.96 kB
../dist/public/assets/index-IK1SN_SD.js                                         2,061.70 kB │ gzip: 494.32 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 9.41s

  dist/index.js  54.4kb

⚡ Done in 7ms
[PM2] Applying action deleteProcessId on app [only-u](ids: [ 0 ])
[PM2] [only-u](0) ✓
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[PM2] Starting /usr/bin/npm in fork_mode (1 instance)
[PM2] Done.
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ only-u             │ fork     │ 0    │ online    │ 0%       │ 15.0mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[TAILING] Tailing last 50 lines for [only-u] process (change the value with --lines option)
/root/.pm2/logs/only-u-out.log last 50 lines:
/root/.pm2/logs/only-u-error.log last 50 lines:
0|only-u   |   }
0|only-u   | }
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:490:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   | TypeError: fetch failed
0|only-u   |     at node:internal/deps/undici/undici:13510:13
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async getDefaultBucketId (file:///var/www/only-u/node_modules/@replit/object-storage/dist/index.mjs:62:20)
0|only-u   |     at async Client.init (file:///var/www/only-u/node_modules/@replit/object-storage/dist/index.mjs:99:51) {
0|only-u   |   [cause]: Error: connect ECONNREFUSED 127.0.0.1:1106
0|only-u   |       at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1611:16) {
0|only-u   |     errno: -111,
0|only-u   |     code: 'ECONNREFUSED',
0|only-u   |     syscall: 'connect',
0|only-u   |     address: '127.0.0.1',
0|only-u   |     port: 1106
0|only-u   |   }
0|only-u   | }
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:490:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   | TypeError: fetch failed
0|only-u   |     at node:internal/deps/undici/undici:13510:13
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async getDefaultBucketId (file:///var/www/only-u/node_modules/@replit/object-storage/dist/index.mjs:62:20)
0|only-u   |     at async Client.init (file:///var/www/only-u/node_modules/@replit/object-storage/dist/index.mjs:99:51) {
0|only-u   |   [cause]: Error: connect ECONNREFUSED 127.0.0.1:1106
0|only-u   |       at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1611:16) {
0|only-u   |     errno: -111,
0|only-u   |     code: 'ECONNREFUSED',
0|only-u   |     syscall: 'connect',
0|only-u   |     address: '127.0.0.1',
0|only-u   |     port: 1106
0|only-u   |   }
0|only-u   | }
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:220:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)

0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
# 1. 環境変数ファイルを確認
cat .env.production

# 2. distフォルダを完全削除
rm -rf dist

# 3. 完全再ビルド
npm run build

# 4. PM2を完全削除して再起動
pm2 delete only-u
pm2 start npm --name "only-u" -- start

# 5. ログ確認
pm2 logs only-u --lines 30
# ステップ1: 環境変数ファイルが存在するか確認
ls -la .env.production
^C
root@srv1087935:/var/www/only-u# # ステップ1: 環境変数ファイルが存在するか確認
ls -la .env.production
-rw-r--r-- 1 root root 764 Oct 27 10:28 .env.production
root@srv1087935:/var/www/only-u# cat .env.production
NODE_ENV=production
PORT=5000
VITE_API_URL=https://only-u.fun
SESSION_SECRET=vK8mN3xP9qR2wE5tY7uI0oP3aS6dF8gH1jK4lZ7xC9vB2nM5qW8eR1tY4uI6oP9a

VITE_FIREBASE_API_KEY=AIzaSyCvUJiZlQMztRs61qTZD7UnY5AYQQ3N1TM
VITE_FIREBASE_PROJECT_ID=onlyu1020-c6696
VITE_FIREBASE_AUTH_DOMAIN=onlyu1020-c6696.firebaseapp.com
VITE_FIREBASE_STORAGE_BUCKET=onlyu1020-c6696.firebasestorage.app
VITE_FIREBASE_MESSAGING_SENDER_ID=627626524087
VITE_FIREBASE_APP_ID=1:627626524087:web:3fb2db22334c6c4e79bc32

VITE_STRIPE_PUBLIC_KEY=pk_live_51SJLZVQXzSGbl6lJ6uiGIHc5dIir5GbtrS0I9g4S3SokXhDuH3eXcK3F7KD4RjdWGtwtuBzcqMyT50pBV1GB1tOs00WNjwwGnW
STRIPE_SECRET_KEY=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

STORAGE_PROVIDER=firebase
root@srv1087935:/var/www/only-u# # distフォルダを削除
rm -rf dist

# 完全再ビルド
npm run build

# PM2を削除
pm2 delete only-u

# 環境変数を読み込んでPM2起動
pm2 start npm --name "only-u" --env production -- start

# 環境変数を保存
pm2 save

# ログ確認
pm2 logs only-u --lines 50

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

vite v5.4.20 building for production...
transforming (4) src/i18n/index.jsxBrowserslist: browsers data (caniuse-lite) is 12 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 2900 modules transformed.
../dist/public/index.html                                                           1.99 kB │ gzip:   0.77 kB
../dist/public/assets/S__23355436_1761458269036-DnkfgHoF.jpg                       36.69 kB
../dist/public/assets/S__23355435_1761458437613-ZtUTYoEc.jpg                       51.25 kB
../dist/public/assets/00465-2336099699_0_1760917144954-6NSR4Dbx.jpg                59.23 kB
../dist/public/assets/00021-2650716505_0_1760917144954-CbSPvP-L.jpg                71.74 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.17.14_1760917144953-C-4BMTeW.png    352.54 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.23.36_1760917144953-C5nM0uTg.png    374.27 kB
../dist/public/assets/00035-3167998813_1760917144953-djSIga3e.png                 581.24 kB
../dist/public/assets/00220-1604543024_0_1760917144953-DgriXLtA.png               632.22 kB
../dist/public/assets/1_1761457956151-sxUpn9Sz.png                              3,238.67 kB
../dist/public/assets/3_1761457956151-BpStuj2a.png                              3,495.80 kB
../dist/public/assets/2_1761457956151-D6P7x4Q3.png                              3,792.85 kB
../dist/public/assets/index-Cjs4TzwM.css                                          181.51 kB │ gzip:  26.96 kB
../dist/public/assets/index-IK1SN_SD.js                                         2,061.70 kB │ gzip: 494.32 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 8.36s

  dist/index.js  54.4kb

⚡ Done in 6ms
[PM2] Applying action deleteProcessId on app [only-u](ids: [ 0 ])
[PM2] [only-u](0) ✓
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[PM2] Starting /usr/bin/npm in fork_mode (1 instance)
[PM2] Done.
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ only-u             │ fork     │ 0    │ online    │ 0%       │ 17.8mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[PM2] Saving current process list...
[PM2] Successfully saved in /root/.pm2/dump.pm2
[TAILING] Tailing last 50 lines for [only-u] process (change the value with --lines option)
/root/.pm2/logs/only-u-error.log last 50 lines:
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u   | 
0|only-u   | Node.js v20.19.5
0|only-u   | file:///var/www/only-u/dist/index.js:217
0|only-u   |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u   |         ^
0|only-u   | 
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u   | 
0|only-u   | Node.js v20.19.5
0|only-u   | file:///var/www/only-u/dist/index.js:217
0|only-u   |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u   |         ^
0|only-u   | 
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u   | 
0|only-u   | Node.js v20.19.5
0|only-u   | file:///var/www/only-u/dist/index.js:217
0|only-u   |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u   |         ^
0|only-u   | 
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u   | 
0|only-u   | Node.js v20.19.5
0|only-u   | file:///var/www/only-u/dist/index.js:217
0|only-u   |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u   |         ^
0|only-u   | 
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u   | 
0|only-u   | Node.js v20.19.5

/root/.pm2/logs/only-u-out.log last 50 lines:
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 

0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | file:///var/www/only-u/dist/index.js:217
0|only-u  |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u  |         ^
0|only-u  | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u  |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u  |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u  |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u  |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u  | Node.js v20.19.5
# Replit Object Storageのインポートを検索
grep -r "@replit/object-storage" server/

# PM2のエコシステムファイルを作成（環境変数を明示的に読み込む）
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'only-u',
    script: 'npm',
    args: 'start',
    env: {
      NODE_ENV: 'production',
      PORT: 5000,
      VITE_API_URL: 'https://only-u.fun',
      SESSION_SECRET: 'vK8mN3xP9qR2wE5tY7uI0oP3aS6dF8gH1jK4lZ7xC9vB2nM5qW8eR1tY4uI6oP9a',
      VITE_FIREBASE_API_KEY: 'AIzaSyCvUJiZlQMztRs61qTZD7UnY5AYQQ3N1TM',
      VITE_FIREBASE_PROJECT_ID: 'onlyu1020-c6696',
      VITE_FIREBASE_AUTH_DOMAIN: 'onlyu1020-c6696.firebaseapp.com',
      VITE_FIREBASE_STORAGE_BUCKET: 'onlyu1020-c6696.firebasestorage.app',
      VITE_FIREBASE_MESSAGING_SENDER_ID: '627626524087',
      VITE_FIREBASE_APP_ID: '1:627626524087:web:3fb2db22334c6c4e79bc32',
      VITE_STRIPE_PUBLIC_KEY: 'pk_live_51SJLZVQXzSGbl6lJ6uiGIHc5dIir5GbtrS0I9g4S3SokXhDuH3eXcK3F7KD4RjdWGtwtuBzcqMyT50pBV1GB1tOs00WNjwwGnW',
      STRIPE_SECRET_KEY: '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',
      STORAGE_PROVIDER: 'firebase'
    }
  }]
};
EOF

# distを削除して完全再ビルド
rm -rf dist
npm run build

# PM2を削除して、エコシステムファイルで再起動
pm2 delete only-u
pm2 start ecosystem.config.js

# ログ確認
pm2 logs only-u --lines 50
^C
root@srv1087935:/var/www/only-u# # Replit Object Storageのインポートを検索
grep -r "@replit/object-storage" server/

# PM2のエコシステムファイルを作成（環境変数を明示的に読み込む）
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'only-u',
    script: 'npm',
    args: 'start',
    env: {
      NODE_ENV: 'production',
      PORT: 5000,
      VITE_API_URL: 'https://only-u.fun',
      SESSION_SECRET: 'vK8mN3xP9qR2wE5tY7uI0oP3aS6dF8gH1jK4lZ7xC9vB2nM5qW8eR1tY4uI6oP9a',
      VITE_FIREBASE_API_KEY: 'AIzaSyCvUJiZlQMztRs61qTZD7UnY5AYQQ3N1TM',
      VITE_FIREBASE_PROJECT_ID: 'onlyu1020-c6696',
      VITE_FIREBASE_AUTH_DOMAIN: 'onlyu1020-c6696.firebaseapp.com',
      VITE_FIREBASE_STORAGE_BUCKET: 'onlyu1020-c6696.firebasestorage.app',
      VITE_FIREBASE_MESSAGING_SENDER_ID: '627626524087',
      VITE_FIREBASE_APP_ID: '1:627626524087:web:3fb2db22334c6c4e79bc32',
      VITE_STRIPE_PUBLIC_KEY: 'pk_live_51SJLZVQXzSGbl6lJ6uiGIHc5dIir5GbtrS0I9g4S3SokXhDuH3eXcK3F7KD4RjdWGtwtuBzcqMyT50pBV1GB1tOs00WNjwwGnW',
      STRIPE_SECRET_KEY: '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',
      STORAGE_PROVIDER: 'firebase'
    }
  }]
};
EOF

# distを削除して完全再ビルド
rm -rf dist
npm run build

# PM2を削除して、エコシステムファイルで再起動
pm2 delete only-u
pm2 start ecosystem.config.js

# ログ確認
pm2 logs only-u --lines 50
server/storage-adapter.ts:import { Client as ReplitClient } from '@replit/object-storage';

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

vite v5.4.20 building for production...
transforming (12) ../node_modules/react-i18next/dist/es/Trans.jsBrowserslist: browsers data (caniuse-lite) is 12 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 2900 modules transformed.
../dist/public/index.html                                                           1.99 kB │ gzip:   0.77 kB
../dist/public/assets/S__23355436_1761458269036-DnkfgHoF.jpg                       36.69 kB
../dist/public/assets/S__23355435_1761458437613-ZtUTYoEc.jpg                       51.25 kB
../dist/public/assets/00465-2336099699_0_1760917144954-6NSR4Dbx.jpg                59.23 kB
../dist/public/assets/00021-2650716505_0_1760917144954-CbSPvP-L.jpg                71.74 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.17.14_1760917144953-C-4BMTeW.png    352.54 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.23.36_1760917144953-C5nM0uTg.png    374.27 kB
../dist/public/assets/00035-3167998813_1760917144953-djSIga3e.png                 581.24 kB
../dist/public/assets/00220-1604543024_0_1760917144953-DgriXLtA.png               632.22 kB
../dist/public/assets/1_1761457956151-sxUpn9Sz.png                              3,238.67 kB
../dist/public/assets/3_1761457956151-BpStuj2a.png                              3,495.80 kB
../dist/public/assets/2_1761457956151-D6P7x4Q3.png                              3,792.85 kB
../dist/public/assets/index-Cjs4TzwM.css                                          181.51 kB │ gzip:  26.96 kB
../dist/public/assets/index-IK1SN_SD.js                                         2,061.70 kB │ gzip: 494.32 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 9.20s

  dist/index.js  54.4kb

⚡ Done in 8ms
[PM2] Applying action deleteProcessId on app [only-u](ids: [ 0 ])
[PM2] [only-u](0) ✓
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[PM2][ERROR] File ecosystem.config.js malformated
ReferenceError: module is not defined in ES module scope
This file is being treated as an ES module because it has a '.js' file extension and '/var/www/only-u/package.json' contains "type": "module". To treat it as a CommonJS script, rename it to use the '.cjs' file extension.
    at file:///var/www/only-u/ecosystem.config.js:1:1
    at ModuleJobSync.runSync (node:internal/modules/esm/module_job:437:37)
    at ModuleLoader.importSyncForRequire (node:internal/modules/esm/loader:389:47)
    at loadESMFromCJS (node:internal/modules/cjs/loader:1363:24)
    at Module._compile (node:internal/modules/cjs/loader:1503:5)
    at Module._extensions..js (node:internal/modules/cjs/loader:1623:10)
    at Module.load (node:internal/modules/cjs/loader:1266:32)
    at Module._load (node:internal/modules/cjs/loader:1091:12)
    at Module.require (node:internal/modules/cjs/loader:1289:19)
    at require (node:internal/modules/helpers:182:18)
[TAILING] Tailing last 50 lines for [only-u] process (change the value with --lines option)
cd /var/www/only-u

# Replit Object Storageのインポートを検索
grep -n "@replit/object-storage" server/*.ts

# 見つかった場合は、そのファイルを確認
cat server/index.ts | head -n 50
^C
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# Replit Object Storageのインポートを検索
grep -n "@replit/object-storage" server/*.ts

# 見つかった場合は、そのファイルを確認
cat server/index.ts | head -n 50
server/storage-adapter.ts:6:import { Client as ReplitClient } from '@replit/object-storage';
import express, { type Request, Response, NextFunction } from "express";
import helmet from "helmet";
import rateLimit from "express-rate-limit";
import cookieParser from "cookie-parser";
import { registerRoutes } from "./routes";
import { setupVite, serveStatic, log } from "./vite";

const app = express();

// Trust proxy for rate limiting (Replit uses reverse proxy)
app.set('trust proxy', 1);

// Cookie parser middleware
app.use(cookieParser());

// Security headers with environment-aware CSP
const isDevelopment = app.get("env") === "development";

// In development, disable CSP to allow Firebase and other services to work without restrictions
// In production, enable strict CSP for security
app.use(helmet({
  contentSecurityPolicy: isDevelopment ? false : {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "https://js.stripe.com", "https://apis.google.com"],
      styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
      fontSrc: ["'self'", "https://fonts.gstatic.com"],
      imgSrc: ["'self'", "data:", "https:", "blob:"],
      connectSrc: [
        "'self'", 
        "https://api.stripe.com", 
        "https://firestore.googleapis.com",
        "https://identitytoolkit.googleapis.com",
        "https://securetoken.googleapis.com",
        "https://*.firebaseio.com",
        "wss://*.firebaseio.com",
        "wss:"
      ],
      frameSrc: ["'self'", "https://js.stripe.com"],
    },
  },
  crossOriginEmbedderPolicy: false,
}));

// Rate limiting for API endpoints
const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // Limit each IP to 100 requests per windowMs
  message: "Too many requests from this IP, please try again later.",
  standardHeaders: true,
root@srv1087935:/var/www/only-u# cd /var/www/only-u

grep -n "@replit/object-storage" server/index.ts
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# cd /var/www/only-u

grep -n "@replit/object-storage" server/index.ts
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# cd /var/www/only-u
root@srv1087935:/var/www/only-u# grep -n "@replit/object-storage" server/index.ts
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# server/routes.tsでReplit Object Storageが使われているか確認
grep -n "replitClient\|objectStorageClient\|@replit" server/routes.ts | head -n 20
1088:        const { ObjectStorageService, objectStorageClient } = await import('./objectStorage');
1111:        const bucket = objectStorageClient.bucket(bucketName);
1318:      const { ObjectStorageService, replitClient } = await import("./objectStorage");
1330:      const result = await replitClient.downloadAsBytes(filePath);
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 該当箇所を確認
sed -n '1085,1115p' server/routes.ts
          return res.status(400).json({ error: 'No file provided' });
        }

        const { ObjectStorageService, objectStorageClient } = await import('./objectStorage');
        const objectStorageService = new ObjectStorageService();

        // Get public search paths
        const publicPaths = await objectStorageService.getPublicObjectSearchPaths();
        if (publicPaths.length === 0) {
          return res.status(500).json({ error: 'Public object storage not configured' });
        }

        // Use first public path
        const publicPath = publicPaths[0];
        const { randomUUID } = await import('crypto');
        const fileId = randomUUID();
        const extension = file.mimetype.split('/')[1];
        const fileName = `slider-${fileId}.${extension}`;
        const fullPath = `${publicPath}/${fileName}`;

        // Parse path
        const pathParts = fullPath.split('/');
        const bucketName = pathParts[1];
        const objectName = pathParts.slice(2).join('/');

        // Upload file
        const bucket = objectStorageClient.bucket(bucketName);
        const blob = bucket.file(objectName);

        const blobStream = blob.createWriteStream({
          resumable: false,
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 該当箇所を確認（行1085-1115と行1315-1335）
sed -n '1085,1115p' server/routes.ts
echo "---"
sed -n '1315,1335p' server/routes.ts
          return res.status(400).json({ error: 'No file provided' });
        }

        const { ObjectStorageService, objectStorageClient } = await import('./objectStorage');
        const objectStorageService = new ObjectStorageService();

        // Get public search paths
        const publicPaths = await objectStorageService.getPublicObjectSearchPaths();
        if (publicPaths.length === 0) {
          return res.status(500).json({ error: 'Public object storage not configured' });
        }

        // Use first public path
        const publicPath = publicPaths[0];
        const { randomUUID } = await import('crypto');
        const fileId = randomUUID();
        const extension = file.mimetype.split('/')[1];
        const fileName = `slider-${fileId}.${extension}`;
        const fullPath = `${publicPath}/${fileName}`;

        // Parse path
        const pathParts = fullPath.split('/');
        const bucketName = pathParts[1];
        const objectName = pathParts.slice(2).join('/');

        // Upload file
        const bucket = objectStorageClient.bucket(bucketName);
        const blob = bucket.file(objectName);

        const blobStream = blob.createWriteStream({
          resumable: false,
---
      console.log('Proxy request for:', folder, filename, 'Object path:', objectPath, 'Range:', req.headers.range);
      
      // Import ObjectStorageService and Replit client
      const { ObjectStorageService, replitClient } = await import("./objectStorage");
      const objectStorageService = new ObjectStorageService();
      
      // Get the file from Object Storage (it will search in public/private dirs automatically)
      const file = await objectStorageService.getObjectEntityFile(objectPath);
      
      // Get full file path for Replit SDK
      const filePath = `/${file.bucket.name}/${file.name}`;
      console.log('[Proxy] Downloading file via Replit SDK:', filePath);
      
      // Download file using Replit SDK (has proper permissions)
      // Replit SDK returns { ok: true, value: [Buffer] }
      const result = await replitClient.downloadAsBytes(filePath);
      
      if (!result.ok || !result.value || !result.value[0] || result.value[0].length === 0) {
        return res.status(404).json({ error: 'File not found' });
      }
      
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 該当箇所を確認（行1085-1115と行1315-1335）
sed -n '1085,1115p' server/routes.ts
echo "---"
sed -n '1315,1335p' server/routes.ts
          return res.status(400).json({ error: 'No file provided' });
        }

        const { ObjectStorageService, objectStorageClient } = await import('./objectStorage');
        const objectStorageService = new ObjectStorageService();

        // Get public search paths
        const publicPaths = await objectStorageService.getPublicObjectSearchPaths();
        if (publicPaths.length === 0) {
          return res.status(500).json({ error: 'Public object storage not configured' });
        }

        // Use first public path
        const publicPath = publicPaths[0];
        const { randomUUID } = await import('crypto');
        const fileId = randomUUID();
        const extension = file.mimetype.split('/')[1];
        const fileName = `slider-${fileId}.${extension}`;
        const fullPath = `${publicPath}/${fileName}`;

        // Parse path
        const pathParts = fullPath.split('/');
        const bucketName = pathParts[1];
        const objectName = pathParts.slice(2).join('/');

        // Upload file
        const bucket = objectStorageClient.bucket(bucketName);
        const blob = bucket.file(objectName);

        const blobStream = blob.createWriteStream({
          resumable: false,
---
      console.log('Proxy request for:', folder, filename, 'Object path:', objectPath, 'Range:', req.headers.range);
      
      // Import ObjectStorageService and Replit client
      const { ObjectStorageService, replitClient } = await import("./objectStorage");
      const objectStorageService = new ObjectStorageService();
      
      // Get the file from Object Storage (it will search in public/private dirs automatically)
      const file = await objectStorageService.getObjectEntityFile(objectPath);
      
      // Get full file path for Replit SDK
      const filePath = `/${file.bucket.name}/${file.name}`;
      console.log('[Proxy] Downloading file via Replit SDK:', filePath);
      
      // Download file using Replit SDK (has proper permissions)
      // Replit SDK returns { ok: true, value: [Buffer] }
      const result = await replitClient.downloadAsBytes(filePath);
      
      if (!result.ok || !result.value || !result.value[0] || result.value[0].length === 0) {
        return res.status(404).json({ error: 'File not found' });
      }
      
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 1. server/routes.tsの修正箇所をアップデート（行1088-1103付近）
# 既存のファイルをバックアップ
cp server/routes.ts server/routes.ts.backup

# sedで該当箇所を修正（行1091-1102）
sed -i '1091,1102s/const { ObjectStorageService } = await import/const { ObjectStorageService } = await import/; 1092s/const { storage } = await import/const { storage: firebaseStorage } = await import/; 1099s/const bucket = storage()/const bucket = firebaseStorage/' server/routes.ts

# 手動で確認して修正（複雑な変更なので）
nano server/routes.ts
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 1. server/routes.tsの修正箇所をアップデート（行1088-1103付近）
# 既存のファイルをバックアップ
cp server/routes.ts server/routes.ts.backup

# sedで該当箇所を修正（行1091-1102）
sed -i '1091,1102s/const { ObjectStorageService } = await import/const { ObjectStorageService } = await import/; 1092s/const { storage } = await import/const { storage: firebaseStorage } = await import/; 1099s/const bucket = storage()/const bucket = firebaseStorage/' server/routes.ts

# 手動で確認して修正（複雑な変更なので）
nano server/routes.ts
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 修正箇所1: 行1091-1103（スライダー画像アップロード）
sed -i '1091s/const { ObjectStorageService } = await import/const { ObjectStorageService } = await import/; 1092s/.*/        const { storage: firebaseStorage } = await import(".\/firebase");/; 1102s/const bucket = storage()/const bucket = firebaseStorage/' server/routes.ts

# より確実な方法：該当部分を直接置換
sed -i '1088,1103s/objectStorageClient/firebaseStorage/g; 1092a\        const { storage: firebaseStorage } = await import(".\/firebase");' server/routes.ts
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 修正箇所1: 行1091-1103（スライダー画像アップロード）
sed -i '1091s/const { ObjectStorageService } = await import/const { ObjectStorageService } = await import/; 1092s/.*/        const { storage: firebaseStorage } = await import(".\/firebase");/; 1102s/const bucket = storage()/const bucket = firebaseStorage/' server/routes.ts

# より確実な方法：該当部分を直接置換
sed -i '1088,1103s/objectStorageClient/firebaseStorage/g; 1092a\        const { storage: firebaseStorage } = await import(".\/firebase");' server/routes.ts
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 1. server/routes.tsの該当2箇所を検索して確認
grep -n "objectStorageClient\|replitClient" server/routes.ts

# 2. 修正スクリプトを実行
cat > /tmp/fix_routes.sh << 'FIXSCRIPT'
#!/bin/bash
cd /var/www/only-u
# バックアップ
cp server/routes.ts server/routes.ts.$(date +%s).bak

# 修正1: 行1088付近の objectStorageClient を削除
sed -i 's/const { ObjectStorageService, objectStorageClient } = await import/const { ObjectStorageService } = await import/g' server/routes.ts
sed -i '/const bucket = objectStorageClient\.bucket/d' server/routes.ts

# 修正2: 行1318付近の replitClient を削除  
sed -i 's/const { ObjectStorageService, replitClient } = await import/const { ObjectStorageService } = await import/g' server/routes.ts
sed -i 's/const result = await replitClient\.downloadAsBytes/\/\/ Removed replitClient/g' server/routes.ts

echo "✅ 修正完了"
FIXSCRIPT

chmod +x /tmp/fix_routes.sh
/tmp/fix_routes.sh

# 3. 確認
grep -n "objectStorageClient\|replitClient" server/routes.ts
1113:        const bucket = objectStorageClient.bucket(bucketName);
1320:      const { ObjectStorageService, replitClient } = await import("./objectStorage");
1332:      const result = await replitClient.downloadAsBytes(filePath);
✅ 修正完了
1331:      // Removed replitClient(filePath);
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# ^C

root@srv1087935:/var/www/only-u# 
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# server/routes.tsの行1088-1126を正しく置換
cat > /tmp/fix_chunk1.txt << 'EOF'
        const { ObjectStorageService } = await import('./objectStorage');
        const { storage: firebaseStorage } = await import('./firebase');

        // Generate unique file name
        const { randomUUID } = await import('crypto');
        const fileId = randomUUID();
        const extension = file.mimetype.split('/')[1];
        const fileName = `slider-${fileId}.${extension}`;

        // Upload to Firebase Storage
        const bucket = firebaseStorage.bucket();
        const blob = bucket.file(`public/${fileName}`);

        const blobStream = blob.createWriteStream({
          resumable: false,
          metadata: {
            contentType: file.mimetype,
          },
        });

        blobStream.on('error', (error: Error) => {
          console.error('Upload error:', error);
          res.status(500).json({ error: 'Error uploading file' });
        });

        blobStream.on('finish', async () => {
          // Make file public
          await blob.makePublic();

          // Return public URL
          const imageUrl = `https://storage.googleapis.com/${bucket.name}/${blob.name}`;
          res.json({ imageUrl });
        });

        blobStream.end(file.buffer);
EOF

削除されました"StorageClient\|replitClient" server/routes.ts || echo "✅ すべて 
1402 server/routes.ts
✅ Python置換完了
=== 確認: objectStorageClient と replitClient が残っていないか ===
1327:      // Removed replitClient(filePath);
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 1. server/routes.tsで問題のある箇所を確認
echo "=== server/routes.ts の問題箇所を確認 ==="
grep -n -A 5 "objectStorageClient\|replitClient" server/routes.ts

# 2. server/storage-adapter.tsを確認
echo "=== server/storage-adapter.ts の先頭50行 ==="
head -n 50 server/storage-adapter.ts

# 3. .env.productionにSESSION_SECRETがあるか確認
echo "=== SESSION_SECRET の確認 ==="
grep SESSION_SECRET .env.production || echo "❌ SESSION_SECRET が見つかりません"=== server/routes.ts の問題箇所を確認 ===
1327:      // Removed replitClient(filePath);
1328-      
1329-      if (!result.ok || !result.value || !result.value[0] || result.value[0].length === 0) {
1330-        return res.status(404).json({ error: 'File not found' });
1331-      }
1332-      
=== server/storage-adapter.ts の先頭50行 ===
/**
 * ストレージアダプター - Replit Object Storage、Cloudflare R2、AWS S3、GCSに対応
 * Hostingerデプロイ時は環境変数でストレージプロバイダーを切り替え可能
 */

import { Client as ReplitClient } from '@replit/object-storage';

// ストレージプロバイダーのタイプ
type StorageProvider = 'replit' | 'r2' | 's3' | 'gcs';

// 環境変数からストレージプロバイダーを判定
const getStorageProvider = (): StorageProvider => {
  if (process.env.R2_ACCOUNT_ID && process.env.R2_ACCESS_KEY_ID) {
    return 'r2';
  }
  if (process.env.AWS_ACCESS_KEY_ID && process.env.AWS_SECRET_ACCESS_KEY) {
    return 's3';
  }
  if (process.env.GCS_PROJECT_ID && process.env.GCS_BUCKET_NAME) {
    return 'gcs';
  }
  // デフォルトはReplit Object Storage
  return 'replit';
};

// ストレージアダプターインターフェース
export interface StorageAdapter {
  upload(key: string, data: Buffer, contentType?: string): Promise<string>;
  download(key: string): Promise<Buffer>;
  delete(key: string): Promise<void>;
  getPublicUrl(key: string): string;
}

// Replit Object Storage アダプター
class ReplitStorageAdapter implements StorageAdapter {
  private client: ReplitClient;

  constructor() {
    this.client = new ReplitClient();
  }

  async upload(key: string, data: Buffer, contentType?: string): Promise<string> {
    const publicKey = `public/${key}`;
    await this.client.uploadFromBytes(publicKey, data);
    return this.getPublicUrl(key);
  }

  async download(key: string): Promise<Buffer> {
    const publicKey = `public/${key}`;
    const result = await this.client.downloadAsBytes(publicKey);
=== SESSION_SECRET の確認 ===
SESSION_SECRET=vK8mN3xP9qR2wE5tY7uI0oP3aS6dF8gH1jK4lZ7xC9vB2nM5qW8eR1tY4uI6oP9a
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# === 修正1: server/storage-adapter.ts を Firebase Storage版に完全置換 ===
cat > server/storage-adapter.ts << 'ENDOFFILE'
/**
 * ストレージアダプター - Firebase Storage、Cloudflare R2、AWS S3、GCSに対応
 * Hostingerデプロイ時は環境変数でストレージプロバイダーを切り替え可能
 */

// Replit Object Storageは削除し、Firebase Storageを使用

// ストレージプロバイダーのタイプ
type StorageProvider = 'firebase' | 'r2' | 's3' | 'gcs';

// 環境変数からストレージプロバイダーを判定
const getStorageProvider = (): StorageProvider => {
  if (process.env.R2_ACCOUNT_ID && process.env.R2_ACCESS_KEY_ID) {
    return 'r2';
  }
  if (process.env.AWS_ACCESS_KEY_ID && process.env.AWS_SECRET_ACCESS_KEY) {
    return 's3';
  }
  if (process.env.GCS_PROJECT_ID && process.env.GCS_BUCKET_NAME) {
    return 'gcs';
  }
  // デフォルトはFirebase Storage
  return 'firebase';
};

// ストレージアダプターインターフェース
export interface StorageAdapter {
  upload(key: string, data: Buffer, contentType?: string): Promise<string>;
  download(key: string): Promise<Buffer>;
  delete(key: string): Promise<void>;
  getPublicUrl(key: string): string;
}

// Firebase Storage アダプター
class FirebaseStorageAdapter implements StorageAdapter {
  private bucket: any;

  constructor() {
pm2 logs only-u --lines 30 --nostream-update-env || echo "✅ ReplitClient削除さ 
✅ server/storage-adapter.ts を更新しました
✅ server/routes.ts を更新しました

=== 確認: objectStorageClient と replitClient ===
✅ すべて削除されました

=== 確認: ReplitClient import ===
✅ ReplitClient削除されました

🔨 ビルド開始...

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

vite v5.4.20 building for production...
transforming (3) src/main.jsxBrowserslist: browsers data (caniuse-lite) is 12 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 2900 modules transformed.
../dist/public/index.html                                                           1.99 kB │ gzip:   0.77 kB
../dist/public/assets/S__23355436_1761458269036-DnkfgHoF.jpg                       36.69 kB
../dist/public/assets/S__23355435_1761458437613-ZtUTYoEc.jpg                       51.25 kB
../dist/public/assets/00465-2336099699_0_1760917144954-6NSR4Dbx.jpg                59.23 kB
../dist/public/assets/00021-2650716505_0_1760917144954-CbSPvP-L.jpg                71.74 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.17.14_1760917144953-C-4BMTeW.png    352.54 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.23.36_1760917144953-C5nM0uTg.png    374.27 kB
../dist/public/assets/00035-3167998813_1760917144953-djSIga3e.png                 581.24 kB
../dist/public/assets/00220-1604543024_0_1760917144953-DgriXLtA.png               632.22 kB
../dist/public/assets/1_1761457956151-sxUpn9Sz.png                              3,238.67 kB
../dist/public/assets/3_1761457956151-BpStuj2a.png                              3,495.80 kB
../dist/public/assets/2_1761457956151-D6P7x4Q3.png                              3,792.85 kB
../dist/public/assets/index-Cjs4TzwM.css                                          181.51 kB │ gzip:  26.96 kB
../dist/public/assets/index-IK1SN_SD.js                                         2,061.70 kB │ gzip: 494.32 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 9.24s
✘ [ERROR] The symbol "fileBuffer" has already been declared

    server/routes.ts:1333:12:
      1333 │       const fileBuffer = result.value[0];
           ╵             ~~~~~~~~~~

  The symbol "fileBuffer" was originally declared here:

    server/routes.ts:1328:13:
      1328 │       const [fileBuffer] = await file.download();
           ╵              ~~~~~~~~~~

1 error

📋 ログを確認（10秒待機）...
[TAILING] Tailing last 30 lines for [only-u] process (change the value with --lines option)
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 行1333の古いコードを削除
sed -i '1333d' server/routes.ts

# 行1329-1331も古い result.ok のチェックなので削除
sed -i '1329,1331d' server/routes.ts

# 確認
echo "=== 行1320-1335付近を確認 ==="
sed -n '1320,1335p' server/routes.ts

# 再ビルド
npm run build
=== 行1320-1335付近を確認 ===
      
      // Get full file path for Replit SDK
      const filePath = `/${file.bucket.name}/${file.name}`;
      console.log('[Proxy] Downloading file via Replit SDK:', filePath);
      
      // Download file using Replit SDK (has proper permissions)
      // Replit SDK returns { ok: true, value: [Buffer] }
      
      const [fileBuffer] = await file.download();
      }
      console.log('[Proxy] Downloaded successfully, size:', fileBuffer.length, 'bytes');
      
      // Determine content type from filename
      const ext = filename.toLowerCase().split('.').pop();
      let contentType = 'application/octet-stream';
      if (ext === 'mp4') contentType = 'video/mp4';

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

vite v5.4.20 building for production...
transforming (3) src/main.jsxBrowserslist: browsers data (caniuse-lite) is 12 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 2900 modules transformed.
../dist/public/index.html                                                           1.99 kB │ gzip:   0.77 kB
../dist/public/assets/S__23355436_1761458269036-DnkfgHoF.jpg                       36.69 kB
../dist/public/assets/S__23355435_1761458437613-ZtUTYoEc.jpg                       51.25 kB
../dist/public/assets/00465-2336099699_0_1760917144954-6NSR4Dbx.jpg                59.23 kB
../dist/public/assets/00021-2650716505_0_1760917144954-CbSPvP-L.jpg                71.74 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.17.14_1760917144953-C-4BMTeW.png    352.54 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.23.36_1760917144953-C5nM0uTg.png    374.27 kB
../dist/public/assets/00035-3167998813_1760917144953-djSIga3e.png                 581.24 kB
../dist/public/assets/00220-1604543024_0_1760917144953-DgriXLtA.png               632.22 kB
../dist/public/assets/1_1761457956151-sxUpn9Sz.png                              3,238.67 kB
../dist/public/assets/3_1761457956151-BpStuj2a.png                              3,495.80 kB
../dist/public/assets/2_1761457956151-D6P7x4Q3.png                              3,792.85 kB
../dist/public/assets/index-Cjs4TzwM.css                                          181.51 kB │ gzip:  26.96 kB
../dist/public/assets/index-IK1SN_SD.js                                         2,061.70 kB │ gzip: 494.32 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 8.66s
✘ [ERROR] Expected "finally" but found "console"

    server/routes.ts:1330:6:
      1330 │       console.log('[Proxy] Downloaded successfully, size:', file...
           │       ~~~~~~~
           ╵       finally

1 error
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 行1305-1340付近を確認
echo "=== 行1305-1340を確認 ==="
sed -n '1305,1340p' server/routes.ts
=== 行1305-1340を確認 ===
  app.get("/api/proxy/:folder/:filename", async (req, res) => {
    try {
      const { folder, filename } = req.params;
      
      // Construct object path in the format getObjectEntityFile expects: /objects/filename
      const objectPath = `/objects/${filename}`;
      
      console.log('Proxy request for:', folder, filename, 'Object path:', objectPath, 'Range:', req.headers.range);
      
      // Import ObjectStorageService and Replit client
      const { ObjectStorageService } = await import("./objectStorage");
      const objectStorageService = new ObjectStorageService();
      
      // Get the file from Object Storage (it will search in public/private dirs automatically)
      const file = await objectStorageService.getObjectEntityFile(objectPath);
      
      // Get full file path for Replit SDK
      const filePath = `/${file.bucket.name}/${file.name}`;
      console.log('[Proxy] Downloading file via Replit SDK:', filePath);
      
      // Download file using Replit SDK (has proper permissions)
      // Replit SDK returns { ok: true, value: [Buffer] }
      
      const [fileBuffer] = await file.download();
      }
      console.log('[Proxy] Downloaded successfully, size:', fileBuffer.length, 'bytes');
      
      // Determine content type from filename
      const ext = filename.toLowerCase().split('.').pop();
      let contentType = 'application/octet-stream';
      if (ext === 'mp4') contentType = 'video/mp4';
      else if (ext === 'mov') contentType = 'video/quicktime';
      else if (ext === 'webm') contentType = 'video/webm';
      else if (ext === 'jpg' || ext === 'jpeg') contentType = 'image/jpeg';
      else if (ext === 'png') contentType = 'image/png';
      else if (ext === 'gif') contentType = 'image/gif';
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 行1315-1340を削除して正しいコードに置き換え
sed -i '1315,1340d' server/routes.ts

# 行1314の後に正しいコードを挿入
sed -i '1314a\      // Import ObjectStorageService\n      const { ObjectStorageService } = await import("./objectStorage");\n      const { storage } = await import("./firebase");\n      const objectStorageService = new ObjectStorageService();\n      \n      // Get the file path from Object Storage (it will search in public/private dirs automatically)\n      const filePath = await objectStorageService.getObjectEntityFile(objectPath);\n      \n      console.log("[Proxy] Downloading file from Firebase Storage:", filePath);\n      \n      // Download file from Firebase Storage\n      const bucket = storage.bucket();\n      const file = bucket.file(filePath);\n      const [fileBuffer] = await file.download();\n      \n      if (!fileBuffer || fileBuffer.length === 0) {\n        return res.status(404).json({ error: "File not found" });\n      }\n      \n      console.log("[Proxy] Downloaded successfully, size:", fileBuffer.length, "bytes");\n      \n      // Determine content type from filename\n      const ext = filename.toLowerCase().split(".").pop();\n      let contentType = "application/octet-stream";\n      if (ext === "mp4") contentType = "video/mp4";\n      else if (ext === "mov") contentType = "video/quicktime";\n      else if (ext === "webm") contentType = "video/webm";\n      else if (ext === "jpg" || ext === "jpeg") contentType = "image/jpeg";\n      else if (ext === "png") contentType = "image/png";\n      else if (ext === "gif") contentType = "image/gif";\n      else if (ext === "webp") contentType = "image/webp";' server/routes.ts

# 確認
echo "=== 修正後の行1305-1350を確認 ==="
sed -n '1305,1350p' server/routes.ts

# ビルド
npm run build
=== 修正後の行1305-1350を確認 ===
  app.get("/api/proxy/:folder/:filename", async (req, res) => {
    try {
      const { folder, filename } = req.params;
      
      // Construct object path in the format getObjectEntityFile expects: /objects/filename
      const objectPath = `/objects/${filename}`;
      
      console.log('Proxy request for:', folder, filename, 'Object path:', objectPath, 'Range:', req.headers.range);
      
      // Import ObjectStorageService and Replit client
      // Import ObjectStorageService
      const { ObjectStorageService } = await import("./objectStorage");
      const { storage } = await import("./firebase");
      const objectStorageService = new ObjectStorageService();
      
      // Get the file path from Object Storage (it will search in public/private dirs automatically)
      const filePath = await objectStorageService.getObjectEntityFile(objectPath);
      
      console.log("[Proxy] Downloading file from Firebase Storage:", filePath);
      
      // Download file from Firebase Storage
      const bucket = storage.bucket();
      const file = bucket.file(filePath);
      const [fileBuffer] = await file.download();
      
      if (!fileBuffer || fileBuffer.length === 0) {
        return res.status(404).json({ error: "File not found" });
      }
      
      console.log("[Proxy] Downloaded successfully, size:", fileBuffer.length, "bytes");
      
      // Determine content type from filename
      const ext = filename.toLowerCase().split(".").pop();
      let contentType = "application/octet-stream";
      if (ext === "mp4") contentType = "video/mp4";
      else if (ext === "mov") contentType = "video/quicktime";
      else if (ext === "webm") contentType = "video/webm";
      else if (ext === "jpg" || ext === "jpeg") contentType = "image/jpeg";
      else if (ext === "png") contentType = "image/png";
      else if (ext === "gif") contentType = "image/gif";
      else if (ext === "webp") contentType = "image/webp";
      else if (ext === 'webp') contentType = 'image/webp';
      
      const fileSize = fileBuffer.length;
      
      // Handle Range requests for video streaming

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

vite v5.4.20 building for production...
transforming (3) src/main.jsxBrowserslist: browsers data (caniuse-lite) is 12 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 2900 modules transformed.
../dist/public/index.html                                                           1.99 kB │ gzip:   0.77 kB
../dist/public/assets/S__23355436_1761458269036-DnkfgHoF.jpg                       36.69 kB
../dist/public/assets/S__23355435_1761458437613-ZtUTYoEc.jpg                       51.25 kB
../dist/public/assets/00465-2336099699_0_1760917144954-6NSR4Dbx.jpg                59.23 kB
../dist/public/assets/00021-2650716505_0_1760917144954-CbSPvP-L.jpg                71.74 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.17.14_1760917144953-C-4BMTeW.png    352.54 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.23.36_1760917144953-C5nM0uTg.png    374.27 kB
../dist/public/assets/00035-3167998813_1760917144953-djSIga3e.png                 581.24 kB
../dist/public/assets/00220-1604543024_0_1760917144953-DgriXLtA.png               632.22 kB
../dist/public/assets/1_1761457956151-sxUpn9Sz.png                              3,238.67 kB
../dist/public/assets/3_1761457956151-BpStuj2a.png                              3,495.80 kB
../dist/public/assets/2_1761457956151-D6P7x4Q3.png                              3,792.85 kB
../dist/public/assets/index-Cjs4TzwM.css                                          181.51 kB │ gzip:  26.96 kB
../dist/public/assets/index-IK1SN_SD.js                                         2,061.70 kB │ gzip: 494.32 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 8.59s

  dist/index.js  54.2kb

⚡ Done in 6ms
root@srv1087935:/var/www/only-u# # PM2で再起動
pm2 restart only-u --update-env

# 10秒待機してログを確認
sleep 10
pm2 logs only-u --lines 50 --nostream

# エラーがあるか確認
echo ""
echo "=== エラーチェック ==="
pm2 logs only-u --lines 20 --nostream --err
[PM2][ERROR] Process or Namespace only-u not found
[TAILING] Tailing last 50 lines for [only-u] process (change the value with --lines option)

=== エラーチェック ===
[TAILING] Tailing last 20 lines for [only-u] process (change the value with --lines option)
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# PM2のプロセス一覧を確認
echo "=== PM2プロセス一覧 ==="
pm2 list

# ecosystem.config.jsを確認
echo ""
echo "=== ecosystem.config.js の確認 ==="
cat ecosystem.config.js

# PM2でアプリケーションを起動
echo ""
echo "🚀 アプリケーションを起動します..."
pm2 start ecosystem.config.js

# 10秒待機してログを確認
sleep 10
pm2 logs only-u --lines 50 --nostream
=== PM2プロセス一覧 ===
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘

=== ecosystem.config.js の確認 ===
module.exports = {
  apps: [{
    name: 'only-u',
    script: 'npm',
    args: 'start',
    env: {
      NODE_ENV: 'production',
      PORT: 5000,
      VITE_API_URL: 'https://only-u.fun',
      SESSION_SECRET: 'vK8mN3xP9qR2wE5tY7uI0oP3aS6dF8gH1jK4lZ7xC9vB2nM5qW8eR1tY4uI6oP9a',
      VITE_FIREBASE_API_KEY: 'AIzaSyCvUJiZlQMztRs61qTZD7UnY5AYQQ3N1TM',
      VITE_FIREBASE_PROJECT_ID: 'onlyu1020-c6696',
      VITE_FIREBASE_AUTH_DOMAIN: 'onlyu1020-c6696.firebaseapp.com',
      VITE_FIREBASE_STORAGE_BUCKET: 'onlyu1020-c6696.firebasestorage.app',
      VITE_FIREBASE_MESSAGING_SENDER_ID: '627626524087',
      VITE_FIREBASE_APP_ID: '1:627626524087:web:3fb2db22334c6c4e79bc32',
      VITE_STRIPE_PUBLIC_KEY: 'pk_live_51SJLZVQXzSGbl6lJ6uiGIHc5dIir5GbtrS0I9g4S3SokXhDuH3eXcK3F7KD4RjdWGtwtuBzcqMyT50pBV1GB1tOs00WNjwwGnW',
      STRIPE_SECRET_KEY: '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',
      STORAGE_PROVIDER: 'firebase'
    }
  }]
};

🚀 アプリケーションを起動します...
[PM2][ERROR] File ecosystem.config.js malformated
ReferenceError: module is not defined in ES module scope
This file is being treated as an ES module because it has a '.js' file extension and '/var/www/only-u/package.json' contains "type": "module". To treat it as a CommonJS script, rename it to use the '.cjs' file extension.
    at file:///var/www/only-u/ecosystem.config.js:1:1
    at ModuleJobSync.runSync (node:internal/modules/esm/module_job:437:37)
    at ModuleLoader.importSyncForRequire (node:internal/modules/esm/loader:389:47)
    at loadESMFromCJS (node:internal/modules/cjs/loader:1363:24)
    at Module._compile (node:internal/modules/cjs/loader:1503:5)
    at Module._extensions..js (node:internal/modules/cjs/loader:1623:10)
    at Module.load (node:internal/modules/cjs/loader:1266:32)
    at Module._load (node:internal/modules/cjs/loader:1091:12)
    at Module.require (node:internal/modules/cjs/loader:1289:19)
    at require (node:internal/modules/helpers:182:18)
[TAILING] Tailing last 50 lines for [only-u] process (change the value with --lines option)
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# ecosystem.config.jsを.cjsにリネーム
mv ecosystem.config.js ecosystem.config.cjs

# 確認
echo "=== ecosystem.config.cjs の内容確認 ==="
cat ecosystem.config.cjs

# PM2でアプリケーションを起動
echo ""
echo "🚀 アプリケーションを起動します..."
pm2 start ecosystem.config.cjs

# 10秒待機してログを確認
echo ""
echo "⏳ 10秒待機中..."
sleep 10

echo ""
echo "📋 ログを確認..."
pm2 logs only-u --lines 50 --nostream
=== ecosystem.config.cjs の内容確認 ===
module.exports = {
  apps: [{
    name: 'only-u',
    script: 'npm',
    args: 'start',
    env: {
      NODE_ENV: 'production',
      PORT: 5000,
      VITE_API_URL: 'https://only-u.fun',
      SESSION_SECRET: 'vK8mN3xP9qR2wE5tY7uI0oP3aS6dF8gH1jK4lZ7xC9vB2nM5qW8eR1tY4uI6oP9a',
      VITE_FIREBASE_API_KEY: 'AIzaSyCvUJiZlQMztRs61qTZD7UnY5AYQQ3N1TM',
      VITE_FIREBASE_PROJECT_ID: 'onlyu1020-c6696',
      VITE_FIREBASE_AUTH_DOMAIN: 'onlyu1020-c6696.firebaseapp.com',
      VITE_FIREBASE_STORAGE_BUCKET: 'onlyu1020-c6696.firebasestorage.app',
      VITE_FIREBASE_MESSAGING_SENDER_ID: '627626524087',
      VITE_FIREBASE_APP_ID: '1:627626524087:web:3fb2db22334c6c4e79bc32',
      VITE_STRIPE_PUBLIC_KEY: 'pk_live_51SJLZVQXzSGbl6lJ6uiGIHc5dIir5GbtrS0I9g4S3SokXhDuH3eXcK3F7KD4RjdWGtwtuBzcqMyT50pBV1GB1tOs00WNjwwGnW',
      STRIPE_SECRET_KEY: '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',
      STORAGE_PROVIDER: 'firebase'
    }
  }]
};

🚀 アプリケーションを起動します...
[PM2][WARN] Applications only-u not running, starting...
[PM2] App [only-u] launched (1 instances)
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ only-u             │ fork     │ 0    │ online    │ 0%       │ 18.0mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘

⏳ 10秒待機中...

📋 ログを確認...
[TAILING] Tailing last 50 lines for [only-u] process (change the value with --lines option)
/root/.pm2/logs/only-u-error.log last 50 lines:
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u   | 
0|only-u   | Node.js v20.19.5
0|only-u   | file:///var/www/only-u/dist/index.js:217
0|only-u   |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u   |         ^
0|only-u   | 
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u   | 
0|only-u   | Node.js v20.19.5
0|only-u   | file:///var/www/only-u/dist/index.js:217
0|only-u   |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u   |         ^
0|only-u   | 
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u   | 
0|only-u   | Node.js v20.19.5
0|only-u   | file:///var/www/only-u/dist/index.js:217
0|only-u   |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u   |         ^
0|only-u   | 
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u   | 
0|only-u   | Node.js v20.19.5
0|only-u   | file:///var/www/only-u/dist/index.js:217
0|only-u   |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u   |         ^
0|only-u   | 
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u   | 
0|only-u   | Node.js v20.19.5

/root/.pm2/logs/only-u-out.log last 50 lines:
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 
0|only-u   | > rest-express@1.0.0 start
0|only-u   | > NODE_ENV=production node dist/index.js
0|only-u   | 
0|only-u   | 11:02:07 AM [express] serving on port 5000

root@srv1087935:/var/www/only-u# # エラーログを確認
echo "=== エラーログ ==="
pm2 logs only-u --err --lines 30 --nostream

# プロセスの状態を確認
echo ""
echo "=== PM2プロセス状態 ==="
pm2 list

# Webサーバーが応答するか確認
echo ""
echo "=== Webサーバー接続テスト ==="
curl -I http://localhost:5000 2>&1 | head -n 10

# Firebase Storageへの接続テスト
echo ""
echo "=== ヘルスチェック ==="
curl http://localhost:5000/api/health 2>&1
=== エラーログ ===
[TAILING] Tailing last 30 lines for [only-u] process (change the value with --lines option)
/root/.pm2/logs/only-u-error.log last 30 lines:
0|only-u   | 
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u   | 
0|only-u   | Node.js v20.19.5
0|only-u   | file:///var/www/only-u/dist/index.js:217
0|only-u   |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u   |         ^
0|only-u   | 
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u   | 
0|only-u   | Node.js v20.19.5
0|only-u   | file:///var/www/only-u/dist/index.js:217
0|only-u   |   throw new Error("Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.");
0|only-u   |         ^
0|only-u   | 
0|only-u   | Error: Missing required environment variable: SESSION_SECRET. Admin authentication requires this for secure token signing.
0|only-u   |     at file:///var/www/only-u/dist/index.js:217:9
0|only-u   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|only-u   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|only-u   |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|only-u   | 
0|only-u   | Node.js v20.19.5


=== PM2プロセス状態 ===
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ only-u             │ fork     │ 0    │ online    │ 0%       │ 56.3mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘

=== Webサーバー接続テスト ===
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0  1991    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
HTTP/1.1 200 OK
Content-Security-Policy: default-src 'self';script-src 'self' https://js.stripe.com https://apis.google.com;style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;font-src 'self' https://fonts.gstatic.com;img-src 'self' data: https: blob:;connect-src 'self' https://api.stripe.com https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com wss:;frame-src 'self' https://js.stripe.com;base-uri 'self';form-action 'self';frame-ancestors 'self';object-src 'none';script-src-attr 'none';upgrade-insecure-requests
Cross-Origin-Opener-Policy: same-origin
Cross-Origin-Resource-Policy: same-origin
Origin-Agent-Cluster: ?1
Referrer-Policy: no-referrer
Strict-Transport-Security: max-age=31536000; includeSubDomains

=== ヘルスチェック ===
{"status":"ok","message":"Server is runningrroot@srv1087root@srv1rootroroorootroot@sroororootroorooroot@srv1087935:/var/www/only-u# # ファイアウォールでポート5000が開いているか確認
echo "=== ファイアウォール確認 ==="
sudo ufw status | grep 5000 || echo "UFWが無効、またはポート5000の設定なし"

# nginxやApacheが80番ポートでリバースプロキシしているか確認
echo ""
echo "=== Webサーバー確認 ==="
sudo systemctl status nginx 2>/dev/null || sudo systemctl status apache2 2>/dev/null || echo "nginx/apache2は未インストール"

# ドメインの設定を確認
echo ""
echo "=== 外部からのアクセステスト（ドメイン経由） ==="
curl -I http://only-u.fun 2>&1 | head -n 5 || echo "ドメイン経由でアクセスできません"
=== ファイアウォール確認 ===
UFWが無効、またはポート5000の設定なし

=== Webサーバー確認 ===
nginx/apache2は未インストール

=== 外部からのアクセステスト（ドメイン経由） ===
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0   795    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
HTTP/1.1 301 Moved Permanently
Date: Mon, 27 Oct 2025 11:03:20 GMT
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# # HTTPSでアクセスしてみる
echo "=== HTTPSでアクセステスト ==="
curl -I https://only-u.fun 2>&1 | head -n 10

# ポート80と443で何が動いているか確認
echo ""
echo "=== ポート80と443の確認 ==="
sudo netstat -tlnp | grep -E ':80 |:443 ' || ss -tlnp | grep -E ':80 |:443 '

# PM2で起動中のアプリの詳細情報
echo ""
echo "=== PM2詳細情報 ==="
pm2 show only-u
=== HTTPSでアクセステスト ===
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0   787    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
HTTP/2 403 
date: Mon, 27 Oct 2025 11:03:52 GMT
content-type: text/html
content-length: 787
vary: Accept-Encoding
cache-control: private, no-cache, no-store, must-revalidate, max-age=0
pragma: no-cache

=== ポート80と443の確認 ===

=== PM2詳細情報 ===
 Describing process with id 0 - name only-u 
┌───────────────────┬──────────────────────────────────┐
│ status            │ online                           │
│ name              │ only-u                           │
│ namespace         │ default                          │
│ version           │ N/A                              │
│ restarts          │ 0                                │
│ uptime            │ 106s                             │
│ script path       │ /usr/bin/npm                     │
│ script args       │ start                            │
│ error log path    │ /root/.pm2/logs/only-u-error.log │
│ out log path      │ /root/.pm2/logs/only-u-out.log   │
│ pid path          │ /root/.pm2/pids/only-u-0.pid     │
│ interpreter       │ /usr/bin/node                    │
│ interpreter args  │ N/A                              │
│ script id         │ 0                                │
│ exec cwd          │ /var/www/only-u                  │
│ exec mode         │ fork_mode                        │
│ node.js version   │ 20.19.5                          │
│ node env          │ production                       │
│ watch & reload    │ ✘                                │
│ unstable restarts │ 0                                │
│ created at        │ 2025-10-27T11:02:06.720Z         │
└───────────────────┴──────────────────────────────────┘
 Actions available 
┌────────────────────────┐
│ km:heapdump            │
│ km:cpu:profiling:start │
│ km:cpu:profiling:stop  │
│ km:heap:sampling:start │
│ km:heap:sampling:stop  │
└────────────────────────┘
 Trigger via: pm2 trigger only-u <action_name>

 Code metrics value 
┌────────────────────────┬──────────┐
│ Used Heap Size         │ 7.44 MiB │
│ Heap Usage             │ 85.21 %  │
│ Heap Size              │ 8.73 MiB │
│ Event Loop Latency p95 │ 1.03 ms  │
│ Event Loop Latency     │ 0.60 ms  │
│ Active handles         │ 5        │
│ Active requests        │ 0        │
└────────────────────────┴──────────┘
 Divergent env variables from local env 


 Add your own code metrics: http://bit.ly/code-metrics
 Use `pm2 logs only-u [--lines 1000]` to display logs
 Use `pm2 env 0` to display environment variables
 Use `pm2 monit` to monitor CPU and Memory usage only-u
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# # ポート5000に外部からアクセスできるか確認
echo "=== ポート5000でのアクセステスト ==="
curl http://212.85.24.206:5000/api/health

# Hostingerのコントロールパネル設定を確認するため、リスニングポートを確認
echo ""
echo "=== リスニングポート一覧 ==="
sudo ss -tlnp | grep LISTEN
=== ポート5000でのアクセステスト ===
{"status":"ok","message":"Server is running"}
=== リスニングポート一覧 ===
LISTEN 0      4096         0.0.0.0:22         0.0.0.0:*    users:(("sshd",pid=1809,fd=3),("systemd",pid=1,fd=120))
LISTEN 0      4096       127.0.0.1:65529      0.0.0.0:*    users:(("monarx-agent",pid=3668,fd=9))                 
LISTEN 0      511          0.0.0.0:5000       0.0.0.0:*    users:(("node",pid=13023,fd=17))                       
LISTEN 0      4096      127.0.0.54:53         0.0.0.0:*    users:(("systemd-resolve",pid=524,fd=17))              
LISTEN 0      4096   127.0.0.53%lo:53         0.0.0.0:*    users:(("systemd-resolve",pid=524,fd=15))              
LISTEN 0      4096            [::]:22            [::]:*    users:(("sshd",pid=1809,fd=4),("systemd",pid=1,fd=122))
root@srv1087935:/var/www/only-u# # Nginxをインストール
sudo apt update
sudo apt install -y nginx

# Nginx設定ファイルを作成
sudo tee /etc/nginx/sites-available/only-u.fun << 'EOF'
server {
    listen 80;
    listen [::]:80;
    server_name only-u.fun www.only-u.fun;

    location / {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

# シンボリックリンクを作成
sudo ln -s /etc/nginx/sites-available/only-u.fun /etc/nginx/sites-enabled/

# デフォルト設定を削除
sudo rm -f /etc/nginx/sites-enabled/default

# Nginx設定をテスト
sudo nginx -t

# Nginxを起動
sudo systemctl enable nginx
sudo systemctl restart nginx

# 確認
echo ""
echo "✅ Nginx設定完了！"
curl -I http://only-u.fun
Hit:1 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble-backports InRelease
Hit:2 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble InRelease                                  
Hit:3 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble-security InRelease                         
Hit:4 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble-updates InRelease                          
Hit:5 https://deb.nodesource.com/node_20.x nodistro InRelease                                     
Hit:6 https://repository.monarx.com/repository/ubuntu-noble noble InRelease                       
Hit:7 http://archive.ubuntu.com/ubuntu noble InRelease                           
Hit:8 http://archive.ubuntu.com/ubuntu noble-updates InRelease
Hit:9 http://archive.ubuntu.com/ubuntu noble-backports InRelease
Hit:10 http://archive.ubuntu.com/ubuntu noble-security InRelease
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
1 package can be upgraded. Run 'apt list --upgradable' to see it.
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following additional packages will be installed:
  nginx-common
Suggested packages:
  fcgiwrap nginx-doc ssl-cert
The following NEW packages will be installed:
  nginx nginx-common
0 upgraded, 2 newly installed, 0 to remove and 1 not upgraded.
Need to get 564 kB of archives.
After this operation, 1596 kB of additional disk space will be used.
Get:1 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble-security/main amd64 nginx-common all 1.24.0-2ubuntu7.5 [43.4 kB]
Get:2 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble-security/main amd64 nginx amd64 1.24.0-2ubuntu7.5 [520 kB]
Fetched 564 kB in 0s (4109 kB/s)
Preconfiguring packages ...
Selecting previously unselected package nginx-common.
(Reading database ... 111885 files and directories currently installed.)
Preparing to unpack .../nginx-common_1.24.0-2ubuntu7.5_all.deb ...
Unpacking nginx-common (1.24.0-2ubuntu7.5) ...
Selecting previously unselected package nginx.
Preparing to unpack .../nginx_1.24.0-2ubuntu7.5_amd64.deb ...
Unpacking nginx (1.24.0-2ubuntu7.5) ...
Setting up nginx-common (1.24.0-2ubuntu7.5) ...
Created symlink /etc/systemd/system/multi-user.target.wants/nginx.service → /usr/lib/systemd/system/nginx.service.
Setting up nginx (1.24.0-2ubuntu7.5) ...
 * Upgrading binary nginx                                                                   [ OK ] 
Processing triggers for man-db (2.12.0-4build2) ...
Processing triggers for ufw (0.36.2-6) ...
Scanning processes...                                                                              
Scanning candidates...                                                                             
Scanning linux images...                                                                           

Pending kernel upgrade!
Running kernel version:
  6.8.0-85-generic
Diagnostics:
  The currently running kernel version is not the expected kernel version 6.8.0-86-generic.

Restarting the system to load the new kernel will not be handled automatically, so you should
consider rebooting.

Restarting services...

Service restarts being deferred:
 systemctl restart unattended-upgrades.service

No containers need to be restarted.

No user sessions are running outdated binaries.

No VM guests are running outdated hypervisor (qemu) binaries on this host.
server {
    listen 80;
    listen [::]:80;
    server_name only-u.fun www.only-u.fun;

    location / {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
Synchronizing state of nginx.service with SysV service script with /usr/lib/systemd/systemd-sysv-install.
Executing: /usr/lib/systemd/systemd-sysv-install enable nginx

✅ Nginx設定完了！
HTTP/1.1 301 Moved Permanently
Date: Mon, 27 Oct 2025 11:05:38 GMT
Content-Type: text/html
Content-Length: 795
Connection: keep-alive
Location: https://only-u.fun/
platform: hostinger
panel: hpanel
Content-Security-Policy: upgrade-insecure-requests
Server: hcdn
alt-svc: h3=":443"; ma=86400
x-hcdn-request-id: aa711d0acd334ad0100ebd7426f489bf-dci-edge3
x-hcdn-cache-status: MISS
x-hcdn-upstream-rt: 0.516

root@srv1087935:/var/www/only-u# # nginxのエラーログを確認
echo "=== Nginxエラーログ ==="
sudo tail -n 50 /var/log/nginx/error.log

# nginxのアクセスログも確認
echo ""
echo "=== Nginxアクセスログ ==="
sudo tail -n 20 /var/log/nginx/access.log

# nginx設定を再確認
echo ""
echo "=== Nginx設定確認 ==="
sudo nginx -t

# nginxのステータスを確認
echo ""
echo "=== Nginxステータス ==="
sudo systemctl status nginx --no-pager

# ポート80でリッスンしているか確認
echo ""
echo "=== ポート80の確認 ==="
sudo ss -tlnp | grep :80
=== Nginxエラーログ ===
2025/10/27 11:05:33 [notice] 13941#13941: using inherited sockets from "5;6;"

=== Nginxアクセスログ ===

=== Nginx設定確認 ===
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful

=== Nginxステータス ===
● nginx.service - A high performance web server and a reverse proxy server
     Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; preset: enabled)
     Active: active (running) since Mon 2025-10-27 11:05:37 UTC; 32s ago
       Docs: man:nginx(8)
    Process: 14170 ExecStartPre=/usr/sbin/nginx -t -q -g daemon on; master_process on; (code=exited, status=0/SUCCESS)
    Process: 14171 ExecStart=/usr/sbin/nginx -g daemon on; master_process on; (code=exited, status=0/SUCCESS)
   Main PID: 14173 (nginx)
      Tasks: 3 (limit: 9483)
     Memory: 2.4M (peak: 2.6M)
        CPU: 15ms
     CGroup: /system.slice/nginx.service
             ├─14173 "nginx: master process /usr/sbin/nginx -g daemon on; master_process on;"
             ├─14174 "nginx: worker process"
             └─14175 "nginx: worker process"

Oct 27 11:05:37 srv1087935 systemd[1]: Starting nginx.service - A high performance web serve…ver...
Oct 27 11:05:37 srv1087935 systemd[1]: Started nginx.service - A high performance web server…erver.
Hint: Some lines were ellipsized, use -l to show in full.

=== ポート80の確認 ===
LISTEN 0      511          0.0.0.0:80         0.0.0.0:*    users:(("nginx",pid=14175,fd=5),("nginx",pid=14174,fd=5),("nginx",pid=14173,fd=5))
LISTEN 0      511             [::]:80            [::]:*    users:(("nginx",pid=14175,fd=6),("nginx",pid=14174,fd=6),("nginx",pid=14173,fd=6))
root@srv1087935:/var/www/only-u# # エラーログを確認（最も重要）
echo "=== Nginxエラーログ（最新50行） ==="
sudo tail -n 50 /var/log/nginx/error.log

# アプリケーションが本当に5000番ポートで動いているか再確認
echo ""
echo "=== localhost:5000のテスト ==="
curl -v http://localhost:5000/ 2>&1 | head -n 30

# ブラウザから見たときの詳細なレスポンス
echo ""
echo "=== 外部からのアクセステスト（詳細） ==="
curl -v http://only-u.fun 2>&1 | head -n 40
=== Nginxエラーログ（最新50行） ===
2025/10/27 11:05:33 [notice] 13941#13941: using inherited sockets from "5;6;"

=== localhost:5000のテスト ===
* Host localhost:5000 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0*   Trying [::1]:5000...
* connect to ::1 port 5000 from ::1 port 58484 failed: Connection refused
*   Trying 127.0.0.1:5000...
* Connected to localhost (127.0.0.1) port 5000
> GET / HTTP/1.1
> Host: localhost:5000
> User-Agent: curl/8.5.0
> Accept: */*
> 
< HTTP/1.1 200 OK
< Content-Security-Policy: default-src 'self';script-src 'self' https://js.stripe.com https://apis.google.com;style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;font-src 'self' https://fonts.gstatic.com;img-src 'self' data: https: blob:;connect-src 'self' https://api.stripe.com https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com wss:;frame-src 'self' https://js.stripe.com;base-uri 'self';form-action 'self';frame-ancestors 'self';object-src 'none';script-src-attr 'none';upgrade-insecure-requests
< Cross-Origin-Opener-Policy: same-origin
< Cross-Origin-Resource-Policy: same-origin
< Origin-Agent-Cluster: ?1
< Referrer-Policy: no-referrer
< Strict-Transport-Security: max-age=31536000; includeSubDomains
< X-Content-Type-Options: nosniff
< X-DNS-Prefetch-Control: off
< X-Download-Options: noopen
< X-Frame-Options: SAMEORIGIN
< X-Permitted-Cross-Domain-Policies: none
< X-XSS-Protection: 0
< Accept-Ranges: bytes
< Cache-Control: public, max-age=0
< Last-Modified: Mon, 27 Oct 2025 11:00:30 GMT

=== 外部からのアクセステスト（詳細） ===
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0* Host only-u.fun:80 was resolved.
* IPv6: 2a02:4780:1b:592e:65d8:ecaa:1f88:5304, 2a02:4780:3b:4f72:6ec2:86d0:9ec4:4838
* IPv4: 153.92.12.197, 91.108.119.233
*   Trying [2a02:4780:1b:592e:65d8:ecaa:1f88:5304]:80...
* Connected to only-u.fun (2a02:4780:1b:592e:65d8:ecaa:1f88:5304) port 80
> GET / HTTP/1.1
> Host: only-u.fun
> User-Agent: curl/8.5.0
> Accept: */*
> 
< HTTP/1.1 301 Moved Permanently
< Date: Mon, 27 Oct 2025 11:06:32 GMT
< Content-Type: text/html
< Content-Length: 795
< Connection: keep-alive
< Location: https://only-u.fun/
< platform: hostinger
< panel: hpanel
< Content-Security-Policy: upgrade-insecure-requests
< Age: 193
< Server: hcdn
< alt-svc: h3=":443"; ma=86400
< x-hcdn-request-id: e2c4f20b8c6e373cfe5fed2249bb1618-dci-edge4
< x-hcdn-cache-status: HIT
< 
{ [795 bytes data]
100   795  100   795    0     0   249k      0 --:--:-- --:--:-- --:--:--  388k
* Connection #0 to host only-u.fun left intact
<!DOCTYPE html>
<html style="height:100%">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<title> 301 Moved Permanently
</title><style>@media (prefers-color-scheme:dark){body{background-color:#000!important}}</style></head>
<body style="color: #444; margin:0;font: normal 14px/20px Arial, Helvetica, sans-serif; height:100%; background-color: #fff;">
<div style="height:auto; min-height:100%; ">     <div style="text-align: center; width:800px; margin-left: -400px; position:absolute; top: 30%; left:50%;">
        <h1 style="margin:0; font-size:150px; line-height:150px; font-weight:bold;">301</h1>
<h2 style="margin-top:20px;font-size: 30px;">Moved Permanently
root@srv1087935:/var/www/only-u# 
root@srv1087935:/var/www/only-u# # Certbotをインストール
sudo apt install -y certbot python3-certbot-nginx

# SSL証明書を取得してnginxを自動設定
# メールアドレスを入力するよう求められます
sudo certbot --nginx -d only-u.fun -d www.only-u.fun

# 自動更新を有効化
sudo systemctl enable certbot.timer
sudo systemctl start certbot.timer

# 確認
echo ""
echo "=== SSL証明書の確認 ==="
sudo certbot certificates

echo ""
echo "=== Nginx設定の確認 ==="
sudo nginx -t

echo ""
echo "✅ 完了！ブラウザで https://only-u.fun にアクセスしてください"
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following additional packages will be installed:
  python3-acme python3-certbot python3-configargparse python3-icu python3-josepy
  python3-parsedatetime python3-rfc3339
Suggested packages:
  python-certbot-doc python3-certbot-apache python-acme-doc python-certbot-nginx-doc
The following NEW packages will be installed:
  certbot python3-acme python3-certbot python3-certbot-nginx python3-configargparse python3-icu
  python3-josepy python3-parsedatetime python3-rfc3339
0 upgraded, 9 newly installed, 0 to remove and 1 not upgraded.
Need to get 1097 kB of archives.
After this operation, 5699 kB of additional disk space will be used.
Get:1 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble/universe amd64 python3-josepy all 1.14.0-1 [22.1 kB]
Get:2 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble/universe amd64 python3-rfc3339 all 1.1-4 [6744 B]
Get:3 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble/universe amd64 python3-acme all 2.9.0-1 [48.5 kB]
Get:4 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble/universe amd64 python3-configargparse all 1.7-1 [31.7 kB]
Get:5 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble/universe amd64 python3-parsedatetime all 2.6-3 [32.8 kB]
Get:6 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble/universe amd64 python3-certbot all 2.9.0-1 [267 kB]
Get:7 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble/universe amd64 certbot all 2.9.0-1 [89.2 kB]
Get:8 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble/universe amd64 python3-certbot-nginx all 2.9.0-1 [66.0 kB]
Get:9 https://cdn.ubuntu.repo.cloudeka.id/ubuntu noble/main amd64 python3-icu amd64 2.12-1build2 [534 kB]
Fetched 1097 kB in 0s (5399 kB/s)   
Preconfiguring packages ...
Selecting previously unselected package python3-josepy.
(Reading database ... 111933 files and directories currently installed.)
Preparing to unpack .../0-python3-josepy_1.14.0-1_all.deb ...
Unpacking python3-josepy (1.14.0-1) ...
Selecting previously unselected package python3-rfc3339.
Preparing to unpack .../1-python3-rfc3339_1.1-4_all.deb ...
Unpacking python3-rfc3339 (1.1-4) ...
Selecting previously unselected package python3-acme.
Preparing to unpack .../2-python3-acme_2.9.0-1_all.deb ...
Unpacking python3-acme (2.9.0-1) ...
Selecting previously unselected package python3-configargparse.
Preparing to unpack .../3-python3-configargparse_1.7-1_all.deb ...
Unpacking python3-configargparse (1.7-1) ...
Selecting previously unselected package python3-parsedatetime.
Preparing to unpack .../4-python3-parsedatetime_2.6-3_all.deb ...
Unpacking python3-parsedatetime (2.6-3) ...
Selecting previously unselected package python3-certbot.
Preparing to unpack .../5-python3-certbot_2.9.0-1_all.deb ...
Unpacking python3-certbot (2.9.0-1) ...
Selecting previously unselected package certbot.
Preparing to unpack .../6-certbot_2.9.0-1_all.deb ...
Unpacking certbot (2.9.0-1) ...
Selecting previously unselected package python3-certbot-nginx.
Preparing to unpack .../7-python3-certbot-nginx_2.9.0-1_all.deb ...
Unpacking python3-certbot-nginx (2.9.0-1) ...
Selecting previously unselected package python3-icu.
Preparing to unpack .../8-python3-icu_2.12-1build2_amd64.deb ...
Unpacking python3-icu (2.12-1build2) ...
Setting up python3-configargparse (1.7-1) ...
Setting up python3-parsedatetime (2.6-3) ...
Setting up python3-icu (2.12-1build2) ...
Setting up python3-josepy (1.14.0-1) ...
Setting up python3-rfc3339 (1.1-4) ...
Setting up python3-acme (2.9.0-1) ...
Setting up python3-certbot (2.9.0-1) ...
Setting up certbot (2.9.0-1) ...
Created symlink /etc/systemd/system/timers.target.wants/certbot.timer → /usr/lib/systemd/system/certbot.timer.
Setting up python3-certbot-nginx (2.9.0-1) ...
Processing triggers for man-db (2.12.0-4build2) ...
Scanning processes...                                                                              
Scanning candidates...                                                                             
Scanning linux images...                                                                           

Pending kernel upgrade!
Running kernel version:
  6.8.0-85-generic
Diagnostics:
  The currently running kernel version is not the expected kernel version 6.8.0-86-generic.

Restarting the system to load the new kernel will not be handled automatically, so you should
consider rebooting.

Restarting services...

Service restarts being deferred:
 systemctl restart unattended-upgrades.service

No containers need to be restarted.

No user sessions are running outdated binaries.

No VM guests are running outdated hypervisor (qemu) binaries on this host.
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Enter email address (used for urgent renewal and security notices)
 (Enter 'c' to cancel): 
Invalid email address: .


If you really want to skip this, you can run the client with
--register-unsafely-without-email but you will then be unable to receive notice
about impending expiration or revocation of your certificates or problems with
your Certbot installation that will lead to failure to renew.

Enter email address (used for urgent renewal and security notices)
 (Enter 'c' to cancel): info@sinjapan.jp

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Please read the Terms of Service at
https://letsencrypt.org/documents/LE-SA-v1.5-February-24-2025.pdf. You must
agree in order to register with the ACME server. Do you agree?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: yes

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Would you be willing, once your first certificate is successfully issued, to
share your email address with the Electronic Frontier Foundation, a founding
partner of the Let's Encrypt project and the non-profit organization that
develops Certbot? We'd like to send you email about our work encrypting the web,
EFF news, campaigns, and ways to support digital freedom.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: yes
Account registered.
Requesting a certificate for only-u.fun and www.only-u.fun

Certbot failed to authenticate some domains (authenticator: nginx). The Certificate Authority reported these problems:
  Domain: only-u.fun
  Type:   unauthorized
  Detail: 2a02:4780:4c:35e4:a4eb:af85:9c20:6bef: Invalid response from http://only-u.fun/.well-known/acme-challenge/HnWbDWitHqGZiA33CwiFuh8ifKqmWTBKKmN3KCoX_38: 404

  Domain: www.only-u.fun
  Type:   unauthorized
  Detail: 2a02:4780:4a:4ce4:98b3:f887:d9da:1111: Invalid response from http://www.only-u.fun/.well-known/acme-challenge/D0gRXQcHuGWdB-EthrMo5vRgb6KerXluiARhR4_-CLc: 404

Hint: The Certificate Authority failed to verify the temporary nginx configuration changes made by Certbot. Ensure the listed domains point to this nginx server and that it is accessible from the internet.

Some challenges have failed.
Ask for help or search for solutions at https://community.letsencrypt.org. See the logfile /var/log/letsencrypt/letsencrypt.log or re-run Certbot with -v for more details.

=== SSL証明書の確認 ===
Saving debug log to /var/log/letsencrypt/letsencrypt.log

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
No certificates found.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

=== Nginx設定の確認 ===
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful

✅ 完了！ブラウザで https://only-u.fun にアクセスしてください
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 1. DNSレコードを確認
echo "=== DNS確認 ==="
echo "A record (IPv4):"
dig +short A only-u.fun
echo "AAAA record (IPv6):"
dig +short AAAA only-u.fun
echo "このVPSのIPアドレス:"
hostname -I

# 2. .well-known/acme-challengeディレクトリを作成
sudo mkdir -p /var/www/html/.well-known/acme-challenge
sudo chown -R www-data:www-data /var/www/html/.well-known
sudo chmod -R 755 /var/www/html/.well-known

# 3. nginx設定を修正（プロキシモードでもACMEチャレンジに対応）
sudo tee /etc/nginx/sites-available/only-u.fun << 'EOF'
server {
    listen 80;
    listen [::]:80;
    server_name only-u.fun www.only-u.fun;

    root /var/www/html;

    # ACME challenge location - MUST come BEFORE location /
    location ^~ /.well-known/acme-challenge/ {
        allow all;
        root /var/www/html;
        default_type "text/plain";
        try_files $uri =404;
    }

    # Proxy to Node.js app
    location / {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

# 4. Nginx設定をテストして再起動
sudo nginx -t && sudo systemctl reload nginx

# 5. テストファイルを作成してアクセス確認
echo "certbot-test" | sudo tee /var/www/html/.well-known/acme-challenge/test.txt
echo "4. その後、再度certbotを実行" 待つ"無効化" にアクセス"
=== DNS確認 ===
A record (IPv4):
91.108.119.37
88.223.91.80
AAAA record (IPv6):
2a02:4780:3a:5596:9a95:5a3a:5ec1:322
2a02:4780:3b:b68b:b263:72c2:a17:de7d
このVPSのIPアドレス:
212.85.24.206 2a02:4780:59:cc86::1 
server {
    listen 80;
    listen [::]:80;
    server_name only-u.fun www.only-u.fun;

    root /var/www/html;

    # ACME challenge location - MUST come BEFORE location /
    location ^~ /.well-known/acme-challenge/ {
        allow all;
        root /var/www/html;
        default_type "text/plain";
        try_files $uri =404;
    }

    # Proxy to Node.js app
    location / {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
certbot-test
<!DOCTYPE html>
<html style="height:100%">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<title> 301 Moved Permanently
</title><style>@media (prefers-color-scheme:dark){body{background-color:#000!important}}</style></head>
<body style="color: #444; margin:0;font: normal 14px/20px Arial, Helvetica, sans-serif; height:100%; background-color: #fff;">
<div style="height:auto; min-height:100%; ">     <div style="text-align: center; width:800px; margin-left: -400px; position:absolute; top: 30%; left:50%;">
        <h1 style="margin:0; font-size:150px; line-height:150px; font-weight:bold;">301</h1>
<h2 style="margin-top:20px;font-size: 30px;">Moved Permanently
</h2>
<p>The document has been permanently moved.</p>
</div></div></body></html>

✅ 準備完了

📝 次のステップ:
1. Hostingerのコントロールパネル → DNS設定 にアクセス
2. AAAA (IPv6) レコードを削除または無効化
3. DNS変更が反映されるまで数分待つ
4. その後、再度certbotを実行
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# 
root@srv1087935:/var/www/only-u# ✅ 完了！ブラウザで https://only-u.fun にアクセスしてください
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 1. DNSレコードを確認
echo "=== DNS確認 ==="
echo "A record (IPv4):"
dig +short A only-u.fun
echo "AAAA record (IPv6):"
dig +short AAAA only-u.fun
echo "このVPSのIPアドレス:"
hostname -I

# 2. .well-known/acme-challengeディレクトリを作成
sudo mkdir -p /var/www/html/.well-known/acme-challenge
sudo chown -R www-data:www-data /var/www/html/.well-known
sudo chmod -R 755 /var/www/html/.well-known

# 3. nginx設定を修正（プロキシモードでもACMEチャレンジに対応）
sudo tee /etc/nginx/sites-available/only-u.fun << 'EOF'
server {
    listen 80;
    listen [::]:80;
    server_name only-u.fun www.only-u.fun;

    root /var/www/html;

    # ACME challenge location - MUST come BEFORE location /
    location ^~ /.well-known/acme-challenge/ {
        allow all;
        root /var/www/html;
        default_type "text/plain";
        try_files $uri =404;
    }

    # Proxy to Node.js app
    location / {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

# 4. Nginx設定をテストして再起動
sudo nginx -t && sudo systemctl reload nginx

# 5. テストファイルを作成してアクセス確認
echo "certbot-test" | sudo tee /var/www/html/.well-known/acme-challenge/test.txt
                                 ^C
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# 1. DNSレコードを確認
echo "=== DNS確認 ==="
echo "A record (IPv4):"
dig +short A only-u.fun
echo "AAAA record (IPv6):"
dig +short AAAA only-u.fun
echo "このVPSのIPアドレス:"
hostname -I

# 2. .well-known/acme-challengeディレクトリを作成
sudo mkdir -p /var/www/html/.well-known/acme-challenge
sudo chown -R www-data:www-data /var/www/html/.well-known
sudo chmod -R 755 /var/www/html/.well-known

# 3. nginx設定を修正（プロキシモードでもACMEチャレンジに対応）
sudo tee /etc/nginx/sites-available/only-u.fun << 'EOF'
server {
    listen 80;
    listen [::]:80;
    server_name only-u.fun www.only-u.fun;

    root /var/www/html;

    # ACME challenge location - MUST come BEFORE location /
    location ^~ /.well-known/acme-challenge/ {
        allow all;
        root /var/www/html;
        default_type "text/plain";
        try_files $uri =404;
    }

    # Proxy to Node.js app
    location / {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

# 4. Nginx設定をテストして再起動
sudo nginx -t && sudo systemctl reload nginx

# 5. テストファイルを作成してアクセス確認
echo "certbot-test" | sudo tee /var/www/html/.well-known/acme-challenge/test.txt
echo "4. その後、再度certbotを実行" 待つ"無効化" にアクセス"
=== DNS確認 ===
A record (IPv4):
91.108.119.37
88.223.91.80
AAAA record (IPv6):
2a02:4780:3a:5596:9a95:5a3a:5ec1:322
2a02:4780:3b:b68b:b263:72c2:a17:de7d
このVPSのIPアドレス:
212.85.24.206 2a02:4780:59:cc86::1 
server {
    listen 80;
    listen [::]:80;
    server_name only-u.fun www.only-u.fun;

    root /var/www/html;

    # ACME challenge location - MUST come BEFORE location /
    location ^~ /.well-known/acme-challenge/ {
        allow all;
        root /var/www/html;
        default_type "text/plain";
        try_files $uri =404;
    }

    # Proxy to Node.js app
    location / {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
certbot-test
<!DOCTYPE html>
<html style="height:100%">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<title> 301 Moved Permanently
</title><style>@media (prefers-color-scheme:dark){body{background-color:#000!important}}</style></head>
<body style="color: #444; margin:0;font: normal 14px/20px Arial, Helvetica, sans-serif; height:100%; background-color: #fff;">
<div style="height:auto; min-height:100%; ">     <div style="text-align: center; width:800px; margin-left: -400px; position:absolute; top: 30%; left:50%;">
        <h1 style="margin:0; font-size:150px; line-height:150px; font-weight:bold;">301</h1>
<h2 style="margin-top:20px;font-size: 30px;">Moved Permanently
</h2>
<p>The document has been permanently moved.</p>
</div></div></body></html>

✅ 準備完了

📝 次のステップ:
1. Hostingerのコントロールパネル → DNS設定 にアクセス
2. AAAA (IPv6) レコードを削除または無効化
3. DNS変更が反映されるまで数分待つ
4. その後、再度certbotを実行
root@srv1087935:/var/www/only-u# cd /var/www/only-u

# DNS確認（数分待ってから）
echo "=== DNS確認（伝播待ち 5分） ==="
sleep 300

echo ""
echo "=== DNS確認 ==="
dig +short A only-u.fun
dig +short A www.only-u.fun

# 両方とも 212.85.24.206 が表示されることを確認

# certbot再実行
echo ""
echo "🔒 SSL証明書を取得します..."
sudo certbot --nginx -d only-u.fun -d www.only-u.fun

# 成功したら確認
echo ""
echo "✅ HTTPSでアクセステスト"
curl -I https://only-u.fun
=== DNS確認（伝播待ち 5分） ===
^C

=== DNS確認 ===
212.85.24.206
212.85.24.206

🔒 SSL証明書を取得します...
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Requesting a certificate for only-u.fun and www.only-u.fun

Successfully received certificate.
Certificate is saved at: /etc/letsencrypt/live/only-u.fun/fullchain.pem
Key is saved at:         /etc/letsencrypt/live/only-u.fun/privkey.pem
This certificate expires on 2026-01-25.
These files will be updated when the certificate renews.
Certbot has set up a scheduled task to automatically renew this certificate in the background.

Deploying certificate
Successfully deployed certificate for only-u.fun to /etc/nginx/sites-enabled/only-u.fun
Successfully deployed certificate for www.only-u.fun to /etc/nginx/sites-enabled/only-u.fun
Congratulations! You have successfully enabled HTTPS on https://only-u.fun and https://www.only-u.fun

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
If you like Certbot, please consider supporting our work by:
 * Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
 * Donating to EFF:                    https://eff.org/donate-le
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

✅ HTTPSでアクセステスト
HTTP/1.1 200 OK
Server: nginx/1.24.0 (Ubuntu)
Date: Mon, 27 Oct 2025 11:17:07 GMT
Content-Type: text/html; charset=UTF-8
Content-Length: 1991
Connection: keep-alive
Content-Security-Policy: default-src 'self';script-src 'self' https://js.stripe.com https://apis.google.com;style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;font-src 'self' https://fonts.gstatic.com;img-src 'self' data: https: blob:;connect-src 'self' https://api.stripe.com https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com wss:;frame-src 'self' https://js.stripe.com;base-uri 'self';form-action 'self';frame-ancestors 'self';object-src 'none';script-src-attr 'none';upgrade-insecure-requests
Cross-Origin-Opener-Policy: same-origin
Cross-Origin-Resource-Policy: same-origin
Origin-Agent-Cluster: ?1
Referrer-Policy: no-referrer
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Content-Type-Options: nosniff
X-DNS-Prefetch-Control: off
X-Download-Options: noopen
X-Frame-Options: SAMEORIGIN
X-Permitted-Cross-Domain-Policies: none
X-XSS-Protection: 0
Accept-Ranges: bytes
Cache-Control: public, max-age=0
Last-Modified: Mon, 27 Oct 2025 11:00:30 GMT
ETag: W/"7c7-19a2553a5a1"

root@srv1087935:/var/www/only-u# # VPSに接続
ssh root@212.85.24.206

# アプリディレクトリに移動
cd /var/www/only-u

# 最新コードをプル（GitHubから）
git pull origin main

# または、ローカルから直接アップロードした場合は、再度アップロードしてください

# 依存関係を更新
npm install

# プロダクションビルドを再実行
npm run build

# PM2でアプリを再起動
pm2 restart only-u

# ログを確認
pm2 logs only-u --lines 50
root@212.85.24.206's password: 
Welcome to Ubuntu 24.04.3 LTS (GNU/Linux 6.8.0-85-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

 System information as of Mon Oct 27 11:27:33 UTC 2025

  System load:  0.0               Processes:             119
  Usage of /:   4.2% of 95.82GB   Users logged in:       1
  Memory usage: 8%                IPv4 address for eth0: 212.85.24.206
  Swap usage:   0%                IPv6 address for eth0: 2a02:4780:59:cc86::1


Expanded Security Maintenance for Applications is not enabled.

0 updates can be applied immediately.

Enable ESM Apps to receive additional future security updates.
See https://ubuntu.com/esm or run: sudo pro status


1 updates could not be installed automatically. For more details,
see /var/log/unattended-upgrades/unattended-upgrades.log

*** System restart required ***
Last login: Mon Oct 27 10:39:24 2025 from 212.85.24.206
root@srv1087935:~# cat .env.production | grep -i firebase
cat: .env.production: No such file or directory
root@srv1087935:~# ^C
root@srv1087935:~# # VPSに接続
ssh root@212.85.24.206

# アプリディレクトリに移動
cd /var/www/only-u

# 最新コードをプル（GitHubから）
git pull origin main

# または、ローカルから直接アップロードした場合は、再度アップロードしてください

# 依存関係を更新
npm install

# プロダクションビルドを再実行
npm run build

# PM2でアプリを再起動
pm2 restart only-u

# ログを確認
pm2 logs only-u --lines 50
root@212.85.24.206's password: 
Welcome to Ubuntu 24.04.3 LTS (GNU/Linux 6.8.0-85-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

 System information as of Mon Oct 27 11:27:33 UTC 2025

  System load:  0.0               Processes:             119
  Usage of /:   4.2% of 95.82GB   Users logged in:       1
  Memory usage: 8%                IPv4 address for eth0: 212.85.24.206
  Swap usage:   0%                IPv6 address for eth0: 2a02:4780:59:cc86::1


Expanded Security Maintenance for Applications is not enabled.

0 updates can be applied immediately.

Enable ESM Apps to receive additional future security updates.
See https://ubuntu.com/esm or run: sudo pro status


1 updates could not be installed automatically. For more details,
see /var/log/unattended-upgrades/unattended-upgrades.log

*** System restart required ***
Last login: Mon Oct 27 11:27:33 2025 from 212.85.24.206
root@srv1087935:~# # アプリディレクトリに移動
cd /var/www/only-u

# 現在のコードの状態を確認
ls -la

# 最新のコードがアップロードされているか確認
# （もしGitを使っている場合は git pull、使っていない場合は以下の確認をスキップ）
git status

# 環境変数の確認（Firebase設定があるか）
echo "=== 環境変数の確認 ==="
cat .env.production | grep -i firebase

# 依存関係を更新
npm install

# プロダクションビルドを実行
npm run build

# PM2でアプリを再起動
pm2 restart only-u

# ログを確認（エラーがないか）
pm2 logs only-u --lines 50
total 764
drwxr-xr-x  11 root root   4096 Oct 27 11:02 .
drwxr-xr-x   4 root root   4096 Oct 27 11:05 ..
-rw-r--r--   1 root root    764 Oct 27 10:28 .env.production
-rw-r--r--   1 root root   1722 Oct 27 10:06 .env.production.example
drwxr-xr-x   8 root root   4096 Oct 27 10:06 .git
-rw-r--r--   1 root root   1292 Oct 27 10:06 .gitignore
-rw-r--r--   1 root root    939 Oct 27 10:06 .replit
-rw-r--r--   1 root root   7605 Oct 27 10:06 HOSTINGER_DEPLOY.md
-rw-r--r--   1 root root   6174 Oct 27 10:06 QUICK_SETUP_CHECKLIST.md
-rw-r--r--   1 root root   4716 Oct 27 10:06 README_DEPLOY.md
-rw-r--r--   1 root root  10020 Oct 27 10:06 SETUP_GUIDE.md
drwxr-xr-x   2 root root  40960 Oct 27 10:06 attached_assets
drwxr-xr-x   4 root root   4096 Oct 27 10:06 client
-rw-r--r--   1 root root    459 Oct 27 10:06 components.json
-rw-r--r--   1 root root   4864 Oct 27 10:06 design_guidelines.md
drwxr-xr-x   3 root root   4096 Oct 27 10:46 dist
-rw-r--r--   1 root root    325 Oct 27 10:06 drizzle.config.ts
-rw-r--r--   1 root root   1001 Oct 27 10:46 ecosystem.config.cjs
-rw-r--r--   1 root root  56156 Oct 27 10:06 generated-icon.png
drwxr-xr-x 474 root root  20480 Oct 27 10:34 node_modules
-rw-r--r--   1 root root 436631 Oct 27 10:34 package-lock.json
-rw-r--r--   1 root root   4507 Oct 27 10:06 package.json
-rw-r--r--   1 root root     80 Oct 27 10:06 postcss.config.js
drwxr-xr-x   3 root root   4096 Oct 27 10:06 public
-rw-r--r--   1 root root   7351 Oct 27 10:06 replit.md
drwxr-xr-x   2 root root   4096 Oct 27 10:06 scripts
drwxr-xr-x   2 root root   4096 Oct 27 11:00 server
drwxr-xr-x   2 root root   4096 Oct 27 10:06 shared
-rw-r--r--   1 root root   1403 Oct 27 10:06 tailwind.config.js
-rw-r--r--   1 root root   4050 Oct 27 10:06 tailwind.config.ts
-rw-r--r--   1 root root    657 Oct 27 10:06 tsconfig.json
-rw-r--r--   1 root root   1080 Oct 27 10:06 vite.config.ts
On branch main
Your branch is up to date with 'origin/main'.

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
	modified:   server/firebase.ts
	modified:   server/objectStorage.ts
	modified:   server/routes.ts
	modified:   server/storage-adapter.ts

Untracked files:
  (use "git add <file>..." to include in what will be committed)
	.env.production
	ecosystem.config.cjs
	server/routes.
	server/routes.ts.1761562539.bak
	server/routes.ts.backup

no changes added to commit (use "git add" and/or "git commit -a")
=== 環境変数の確認 ===
VITE_FIREBASE_API_KEY=AIzaSyCvUJiZlQMztRs61qTZD7UnY5AYQQ3N1TM
VITE_FIREBASE_PROJECT_ID=onlyu1020-c6696
VITE_FIREBASE_AUTH_DOMAIN=onlyu1020-c6696.firebaseapp.com
VITE_FIREBASE_STORAGE_BUCKET=onlyu1020-c6696.firebasestorage.app
VITE_FIREBASE_MESSAGING_SENDER_ID=627626524087
VITE_FIREBASE_APP_ID=1:627626524087:web:3fb2db22334c6c4e79bc32
STORAGE_PROVIDER=firebase

up to date, audited 786 packages in 2s

89 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (3 low, 5 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

vite v5.4.20 building for production...
transforming (3) src/main.jsxBrowserslist: browsers data (caniuse-lite) is 12 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 2900 modules transformed.
../dist/public/index.html                                                           1.99 kB │ gzip:   0.77 kB
../dist/public/assets/S__23355436_1761458269036-DnkfgHoF.jpg                       36.69 kB
../dist/public/assets/S__23355435_1761458437613-ZtUTYoEc.jpg                       51.25 kB
../dist/public/assets/00465-2336099699_0_1760917144954-6NSR4Dbx.jpg                59.23 kB
../dist/public/assets/00021-2650716505_0_1760917144954-CbSPvP-L.jpg                71.74 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.17.14_1760917144953-C-4BMTeW.png    352.54 kB
../dist/public/assets/スクリーンショット 2025-10-08 22.23.36_1760917144953-C5nM0uTg.png    374.27 kB
../dist/public/assets/00035-3167998813_1760917144953-djSIga3e.png                 581.24 kB
../dist/public/assets/00220-1604543024_0_1760917144953-DgriXLtA.png               632.22 kB
../dist/public/assets/1_1761457956151-sxUpn9Sz.png                              3,238.67 kB
../dist/public/assets/3_1761457956151-BpStuj2a.png                              3,495.80 kB
../dist/public/assets/2_1761457956151-D6P7x4Q3.png                              3,792.85 kB
../dist/public/assets/index-Cjs4TzwM.css                                          181.51 kB │ gzip:  26.96 kB
../dist/public/assets/index-IK1SN_SD.js                                         2,061.70 kB │ gzip: 494.32 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 9.34s

  dist/index.js  54.2kb

⚡ Done in 8ms
Use --update-env to update environment variables
[PM2] Applying action restartProcessId on app [only-u](ids: [ 0 ])
[PM2] [only-u](0) ✓
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ only-u             │ fork     │ 1    │ online    │ 0%       │ 19.6mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[TAILING] Tailing last 50 lines for [only-u] process (change the value with --lines option)
/root/.pm2/logs/only-u-out.log last 50 lines:
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u   | Proxy request for: public 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Object path: /objects/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Range: undefined
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u   | 11:26:46 AM [express] GET /api/proxy/public/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 404 in 752ms :: …
0|only-u   | Proxy request for: public 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Object path: /objects/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Range: bytes=0-
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | Proxy request for: public ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV Object path: /objects/ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV Range: bytes=0-
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | Proxy request for: public 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV Object path: /objects/34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV Range: bytes=0-
0|only-u   | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | 11:26:47 AM [express] GET /api/proxy/public/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 404 in 771ms :: …
0|only-u   | Proxy request for: public 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Object path: /objects/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Range: bytes=0-
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | 11:26:48 AM [express] GET /api/proxy/public/34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV 404 in 619ms :: …
0|only-u   | 11:26:48 AM [express] GET /api/proxy/public/ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV 404 in 728ms :: …
0|only-u   | 11:26:48 AM [express] GET /api/proxy/public/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 404 in 622ms :: …
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u   | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u   | Proxy request for: public 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV Object path: /objects/34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV Range: bytes=0-1
0|only-u   | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | Proxy request for: public c86ffb98-ca5a-469e-af17-354a7c5e9fe7.MOV Object path: /objects/c86ffb98-ca5a-469e-af17-354a7c5e9fe7.MOV Range: bytes=0-1
0|only-u   | [getObjectEntityFile] entityId: c86ffb98-ca5a-469e-af17-354a7c5e9fe7.MOV
0|only-u   | 11:26:56 AM [express] GET /api/proxy/public/34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV 404 in 715ms :: …
0|only-u   | 11:26:56 AM [express] GET /api/proxy/public/c86ffb98-ca5a-469e-af17-354a7c5e9fe7.MOV 404 in 714ms :: …
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4

/root/.pm2/logs/only-u-error.log last 50 lines:
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u   | Error serving object: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u   | Error serving object: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u   | Error serving object: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u   | Error serving object: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u   | Error serving object: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u   | Error serving object: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u   | Error serving object: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u   | Error serving object: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u   | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:1149:24
0|only-u   | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:1149:24
0|only-u   | Error serving object: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u   | Error serving object: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26

0|only-u  | 11:28:58 AM [express] serving on port 5000
0|only-u  | Proxy request for: public 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV Object path: /objects/34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV Range: bytes=0-1
0|only-u  | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u  | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u  | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u  | Proxy request for: public c86ffb98-ca5a-469e-af17-354a7c5e9fe7.MOV Object path: /objects/c86ffb98-ca5a-469e-af17-354a7c5e9fe7.MOV Range: bytes=0-1
0|only-u  | [getObjectEntityFile] entityId: c86ffb98-ca5a-469e-af17-354a7c5e9fe7.MOV
0|only-u  | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u  | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:1149:24
0|only-u  | 11:29:19 AM [express] GET /api/proxy/public/c86ffb98-ca5a-469e-af17-354a7c5e9fe7.MOV 404 in 731ms :: …
0|only-u  | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:1149:24
0|only-u  | 11:29:19 AM [express] GET /api/proxy/public/34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV 404 in 975ms :: …
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u  | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u  | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u  | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u  | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | Proxy request for: public 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Object path: /objects/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Range: undefined
0|only-u  | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u  | Proxy request for: public 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Object path: /objects/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Range: bytes=0-1
0|only-u  | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u  | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:1149:24
0|only-u  | 11:29:22 AM [express] GET /api/proxy/public/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 404 in 749ms :: …
0|only-u  | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:1149:24
0|only-u  | 11:29:22 AM [express] GET /api/proxy/public/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 404 in 669ms :: …
0|only-u  | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u  | Proxy request for: public 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Object path: /objects/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Range: bytes=0-1
0|only-u  | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u  | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u  | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u  | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:1149:24
0|only-u  | 11:29:23 AM [express] GET /api/proxy/public/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 404 in 596ms :: …
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | Proxy request for: public 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Object path: /objects/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Range: bytes=0-1
0|only-u  | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u  | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:1149:24
0|only-u  | 11:29:26 AM [express] GET /api/proxy/public/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 404 in 713ms :: …
0|only-u  | Proxy request for: public 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV Object path: /objects/34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV Range: bytes=0-1
0|only-u  | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u  | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u  | Proxy request for: public 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV Object path: /objects/34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV Range: bytes=0-1
0|only-u  | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u  | Proxy request for: public 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Object path: /objects/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Range: bytes=0-1
0|only-u  | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u  | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u  | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:1149:24
0|only-u  | 11:29:27 AM [express] GET /api/proxy/public/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 404 in 494ms :: …
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | Error serving object: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u  | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:1149:24
0|only-u  | 11:29:27 AM [express] GET /api/proxy/public/34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV 404 in 612ms :: …
0|only-u  | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u  |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u  |     at async file:///var/www/only-u/dist/index.js:1149:24
0|only-u  | 11:29:27 AM [express] GET /api/proxy/public/34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV 404 in 608ms :: …

^C
root@srv1087935:/var/www/only-u# 
root@srv1087935:/var/www/only-u# # 1. 環境変数の確認
echo "=== 環境変数チェック ==="
cat .env.production

# もし .env.production が存在しない、または内容が不足している場合は作成
cat > .env.production << 'EOF'
NODE_ENV=production
SESSION_SECRET=your-very-secure-random-session-secret-change-this-to-random-string

# Firebase設定
FIREBASE_PROJECT_ID=onlyu1020-c6696
FIREBASE_STORAGE_BUCKET=onlyu1020-c6696.firebasestorage.app

# Stripe (本番環境のキー)
STRIPE_SECRET_KEY=sk_live_your_stripe_secret_key
VITE_STRIPE_PUBLIC_KEY=pk_live_your_stripe_public_key
EOF

# 2. PM2の環境変数設定を更新
pm2 delete only-u
pm2 start ecosystem.config.cjs

# 3. ログ確認
pm2 logs only-u --lines 30
=== 環境変数チェック ===
NODE_ENV=production
PORT=5000
VITE_API_URL=https://only-u.fun
SESSION_SECRET=vK8mN3xP9qR2wE5tY7uI0oP3aS6dF8gH1jK4lZ7xC9vB2nM5qW8eR1tY4uI6oP9a

VITE_FIREBASE_API_KEY=AIzaSyCvUJiZlQMztRs61qTZD7UnY5AYQQ3N1TM
VITE_FIREBASE_PROJECT_ID=onlyu1020-c6696
VITE_FIREBASE_AUTH_DOMAIN=onlyu1020-c6696.firebaseapp.com
VITE_FIREBASE_STORAGE_BUCKET=onlyu1020-c6696.firebasestorage.app
VITE_FIREBASE_MESSAGING_SENDER_ID=627626524087
VITE_FIREBASE_APP_ID=1:627626524087:web:3fb2db22334c6c4e79bc32

VITE_STRIPE_PUBLIC_KEY=pk_live_51SJLZVQXzSGbl6lJ6uiGIHc5dIir5GbtrS0I9g4S3SokXhDuH3eXcK3F7KD4RjdWGtwtuBzcqMyT50pBV1GB1tOs00WNjwwGnW
STRIPE_SECRET_KEY=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

STORAGE_PROVIDER=firebase
[PM2] Applying action deleteProcessId on app [only-u](ids: [ 0 ])
[PM2] [only-u](0) ✓
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[PM2][WARN] Applications only-u not running, starting...
[PM2] App [only-u] launched (1 instances)
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ only-u             │ fork     │ 0    │ online    │ 0%       │ 19.1mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[TAILING] Tailing last 30 lines for [only-u] process (change the value with --lines option)
/root/.pm2/logs/only-u-error.log last 30 lines:
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u   | Error serving object: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u   | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:1149:24
0|only-u   | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:1149:24
0|only-u   | Error serving object: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u   | Error serving object: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:652:26
0|only-u   | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:1149:24
0|only-u   | Error proxying file: _ObjectNotFoundError: Object not found
0|only-u   |     at ObjectStorageService.getObjectEntityFile (file:///var/www/only-u/dist/index.js:154:15)
0|only-u   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|only-u   |     at async file:///var/www/only-u/dist/index.js:1149:24

/root/.pm2/logs/only-u-out.log last 30 lines:
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | Proxy request for: public 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Object path: /objects/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Range: undefined
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | Proxy request for: public 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Object path: /objects/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Range: bytes=0-1
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | 11:29:22 AM [express] GET /api/proxy/public/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 404 in 749ms :: …
0|only-u   | 11:29:22 AM [express] GET /api/proxy/public/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 404 in 669ms :: …
0|only-u   | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u   | Proxy request for: public 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Object path: /objects/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Range: bytes=0-1
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u   | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | 11:29:23 AM [express] GET /api/proxy/public/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 404 in 596ms :: …
0|only-u   | Proxy request for: public 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Object path: /objects/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Range: bytes=0-1
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | 11:29:26 AM [express] GET /api/proxy/public/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 404 in 713ms :: …
0|only-u   | Proxy request for: public 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV Object path: /objects/34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV Range: bytes=0-1
0|only-u   | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | Proxy request for: public 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV Object path: /objects/34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV Range: bytes=0-1
0|only-u   | [getObjectEntityFile] entityId: 34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV
0|only-u   | Proxy request for: public 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Object path: /objects/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 Range: bytes=0-1
0|only-u   | [getObjectEntityFile] entityId: 3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4
0|only-u   | [getObjectEntityFile] entityId: ec18842e-a51f-462e-94ac-f2ad51bf6a48.MOV
0|only-u   | 11:29:27 AM [express] GET /api/proxy/public/3399c1e2-6d59-4453-b9a9-2e7dcd97646d.MP4 404 in 494ms :: …
0|only-u   | 11:29:27 AM [express] GET /api/proxy/public/34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV 404 in 612ms :: …
0|only-u   | 11:29:27 AM [express] GET /api/proxy/public/34b976ee-66b3-49dd-a29f-6d93c969b2db.MOV 404 in 608ms :: …

0|only-u  | > rest-express@1.0.0 start
0|only-u  | > NODE_ENV=production node dist/index.js
0|only-u  | 11:30:09 AM [express] serving on port 5000
# 1. 環境変数ファイルを作成
cat > .env.production << 'EOF'
NODE_ENV=production
SESSION_SECRET=only-u-super-secure-random-secret-key-2025-change-this-in-production

# Firebase設定
FIREBASE_PROJECT_ID=onlyu1020-c6696
FIREBASE_STORAGE_BUCKET=onlyu1020-c6696.firebasestorage.app

# Stripe (本番環境のキーに変更してください)
STRIPE_SECRET_KEY=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
VITE_STRIPE_PUBLIC_KEY=pk_live_51QIEWoJhvhyJJDcCP9Z9ZkzL0T7qV3vY0kL8zL3L3L3L3L3L3L3L3L3L3L3L3L
EOF

# 2. server/objectStorage.ts の内容を確認
head -n 50 server/objectStorage.ts

# 3. もしまだReplit Object Storageのコードが残っている場合、Replit環境から最新のファイルをコピー
# またはReplitの最新コードをVPSにアップロードする必要があります
^C
root@srv1087935:/var/www/only-u# # 1. 環境変数ファイルを作成
cat > .env.production << 'EOF'
NODE_ENV=production
SESSION_SECRET=only-u-super-secure-random-secret-key-2025-change-this-in-production

# Firebase設定
FIREBASE_PROJECT_ID=onlyu1020-c6696
FIREBASE_STORAGE_BUCKET=onlyu1020-c6696.firebasestorage.app

# Stripe (本番環境のキーに変更してください)
STRIPE_SECRET_KEY=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
VITE_STRIPE_PUBLIC_KEY=pk_live_51QIEWoJhvhyJJDcCP9Z9ZkzL0T7qV3vY0kL8zL3L3L3L3L3L3L3L3L3L3L3L3L
EOF

# 2. server/objectStorage.ts の内容を確認
head -n 50 server/objectStorage.ts

# 3. もしまだReplit Object Storageのコードが残っている場合、Replit環境から最新のファイルをコピー
# またはReplitの最新コードをVPSにアップロードする必要があります
// Object Storage Service for managing large video and image uploads
// Modified for VPS deployment - uses Firebase Storage instead of Replit Object Storage
import { Storage as FirebaseStorage } from "firebase-admin/storage";
import { Response } from "express";
import { randomUUID } from "crypto";

export class ObjectNotFoundError extends Error {
  constructor() {
    super("Object not found");
    this.name = "ObjectNotFoundError";
    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);
  }
}

let firebaseStorageBucket: ReturnType<FirebaseStorage["bucket"]> | null = null;

async function getFirebaseStorageBucket() {
  if (!firebaseStorageBucket) {
    const { storage } = await import('./firebase');
    firebaseStorageBucket = storage.bucket();
  }
  return firebaseStorageBucket;
}

export class ObjectStorageService {
  constructor() {}

  async uploadFile(
    fileBuffer: Buffer,
    fileName: string,
    userId: string,
    contentType?: string,
    visibility: 'public' | 'private' = 'public'
  ): Promise<{ objectPath: string; storageUri: string }> {
    const bucket = await getFirebaseStorageBucket();
    const objectId = randomUUID();
    const extension = fileName.split('.').pop();
    const folderPath = visibility === 'public' ? 'public' : 'private';
    const fullStoragePath = `${folderPath}/${objectId}.${extension}`;

    console.log('[uploadFile] Uploading to Firebase Storage:', fullStoragePath);

    try {
      const file = bucket.file(fullStoragePath);
      await file.save(fileBuffer, {
        contentType: contentType || 'application/octet-stream',
        metadata: {
          metadata: {
            uploadedBy: userId,
            visibility: visibility,
root@srv1087935:/var/www/only-u# ^C
root@srv1087935:/var/www/only-u# # 1. 環境変数ファイルを作成
cat > .env.production << 'EOF'
NODE_ENV=production
SESSION_SECRET=only-u-super-secure-random-secret-key-2025-change-this-in-production

# Firebase設定
FIREBASE_PROJECT_ID=onlyu1020-c6696
FIREBASE_STORAGE_BUCKET=onlyu1020-c6696.firebasestorage.app

# Stripe (本番環境のキーに変更してください)
STRIPE_SECRET_KEY=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
VITE_STRIPE_PUBLIC_KEY=pk_live_51QIEWoJhvhyJJDcCP9Z9ZkzL0T7qV3vY0kL8zL3L3L3L3L3L3L3L3L3L3L3L3L
EOF

# 2. server/objectStorage.ts の内容を確認
head -n 50 server/objectStorage.ts

# 3. もしまだReplit Object Storageのコードが残っている場合、Replit環境から最新のファイルをコピー
# またはReplitの最新コードをVPSにアップロードする必要があります
// Object Storage Service for managing large video and image uploads
// Modified for VPS deployment - uses Firebase Storage instead of Replit Object Storage
import { Storage as FirebaseStorage } from "firebase-admin/storage";
import { Response } from "express";
import { randomUUID } from "crypto";

export class ObjectNotFoundError extends Error {
  constructor() {
    super("Object not found");
    this.name = "ObjectNotFoundError";
    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);
  }
}

let firebaseStorageBucket: ReturnType<FirebaseStorage["bucket"]> | null = null;

async function getFirebaseStorageBucket() {
  if (!firebaseStorageBucket) {
    const { storage } = await import('./firebase');
    firebaseStorageBucket = storage.bucket();
  }
  return firebaseStorageBucket;
}

export class ObjectStorageService {
  constructor() {}

  async uploadFile(
    fileBuffer: Buffer,
    fileName: string,
    userId: string,
    contentType?: string,
    visibility: 'public' | 'private' = 'public'
  ): Promise<{ objectPath: string; storageUri: string }> {
    const bucket = await getFirebaseStorageBucket();
    const objectId = randomUUID();
    const extension = fileName.split('.').pop();
    const folderPath = visibility === 'public' ? 'public' : 'private';
    const fullStoragePath = `${folderPath}/${objectId}.${extension}`;

    console.log('[uploadFile] Uploading to Firebase Storage:', fullStoragePath);

    try {
      const file = bucket.file(fullStoragePath);
      await file.save(fileBuffer, {
        contentType: contentType || 'application/octet-stream',
        metadata: {
          metadata: {
            uploadedBy: userId,
            visibility: visibility,
root@srv1087935:/var/www/only-u# 
